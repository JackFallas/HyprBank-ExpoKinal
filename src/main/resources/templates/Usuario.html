<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8" />
    <title>Usuario | kinalBAnk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Transici√≥n para el contenido principal cuando cambia su margen */
        #contenido {
            transition: margin-left 0.3s ease;
        }
        /* Cuando la barra est√° visible, damos margen izquierdo para que no quede tapado */
        #contenido.con-sidebar-visible {
            margin-left: 16rem; /* igual al width de sidebar (w-64 = 16rem) */
        }
        /* Estilo para el submen√∫ desplegable en la barra lateral */
        .submenu-item {
            padding-left: 3.5rem; /* Indentaci√≥n para elementos del submen√∫ */
            font-size: 0.95rem; /* Ligeramente m√°s peque√±o */
            color: #a0aec0; /* Gris m√°s claro */
        }
        .submenu-item:hover {
            background-color: #047857; /* Emerald-700 */
            color: white;
        }
        /* Estilo para el overlay */
        #overlay {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
        #overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">

    <div class="flex min-h-screen">

        <button id="btnToggleSidebar" class="fixed top-4 left-4 z-50 bg-emerald-600 p-3 rounded-md shadow-md hover:bg-emerald-700 transition focus:outline-none focus:ring-2 focus:ring-emerald-400">
            ‚ò∞
        </button>

        <!-- Overlay para cerrar el sidebar al hacer clic fuera en m√≥vil -->
        <div id="overlay" class="fixed inset-0 z-30 bg-black opacity-0 pointer-events-none transition-opacity duration-300 hidden"></div>

        <aside id="sidebar" class="fixed top-0 left-0 z-40 w-64 h-screen bg-gray-800 flex flex-col p-6 space-y-6 -translate-x-full transition-transform duration-300">
            <div>
                <div class="flex items-center space-x-3 text-2xl font-bold text-white mb-6 select-none">
                    <span>üè¶</span><span>kinalBAnk</span>
                </div>
                <nav class="flex flex-col space-y-3">
                    <a href="#" data-id="inicio" class="sidebar-link flex items-center px-4 py-3 rounded-full text-gray-300 hover:bg-emerald-600 hover:text-white cursor-pointer transition-transform duration-300 ease-in-out hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M13 5v6h6" />
                        </svg>
                        Inicio
                    </a>
                    
                    <a href="#" data-id="miCuenta" class="sidebar-link flex items-center px-4 py-3 rounded-full text-gray-300 hover:bg-emerald-600 hover:text-white cursor-pointer transition-transform duration-300 ease-in-out hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A7 7 0 1117.803 5.12M12 12v.01" />
                        </svg>
                        Mi cuenta
                    </a>
                    
                    <a href="#" id="toggleTransaccionesSidebar" class="sidebar-link flex items-center px-4 py-3 rounded-full text-gray-300 hover:bg-emerald-600 hover:text-white cursor-pointer transition-transform duration-300 ease-in-out hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9l-7 7-7-7" />
                        </svg>
                        Transacciones
                        <svg id="arrowIconTransacciones" class="ml-auto h-4 w-4 transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </a>
                    <div id="submenuTransacciones" class="hidden flex flex-col space-y-2 mt-2">
                        <a href="#" data-id="transferenciasInternas" class="submenu-item flex items-center px-4 py-2 rounded-full text-gray-300 hover:bg-emerald-600 hover:text-white cursor-pointer transition-transform duration-300 ease-in-out hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                            </svg>
                            Transferencia entre mis cuentas
                        </a>
                        <a href="#" data-id="transferenciasOtrosUsuarios" class="submenu-item flex items-center px-4 py-2 rounded-full text-gray-300 hover:bg-emerald-600 hover:text-white cursor-pointer transition-transform duration-300 ease-in-out hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                            </svg>
                            Transferencia a otro usuario
                        </a>
                    </div>

                    <a href="#" data-id="historial" class="sidebar-link flex items-center px-4 py-3 rounded-full text-gray-300 hover:bg-emerald-600 hover:text-white cursor-pointer transition-transform duration-300 ease-in-out hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 17l4 4m0 0l4-4m-4 4V3" />
                        </svg>
                        Historial
                    </a>

                    <a href="#" id="toggleServiciosSidebar" class="sidebar-link flex items-center px-4 py-3 rounded-full text-gray-300 hover:bg-emerald-600 hover:text-white cursor-pointer transition-transform duration-300 ease-in-out hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2a4 4 0 014-4h3" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 9V7a4 4 0 014-4h3" />
                        </svg>
                        Servicios
                        <svg id="arrowIcon" class="ml-auto h-4 w-4 transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </a>
                    <div id="submenuServicios" class="hidden flex flex-col space-y-2 mt-2">
                    </div>
                </nav>
            </div>

            <div class="mt-auto">
                <a href="/logout" data-id="cerrarSesion" class="flex items-center px-4 py-3 rounded-full text-gray-300 hover:bg-red-600 hover:text-white cursor-pointer transition-transform duration-300 ease-in-out hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7" />
                    </svg>
                    Cerrar sesi√≥n
                </a>
            </div>
        </aside>

        <main id="contenido" class="flex-1 p-8 bg-gray-900 overflow-auto min-h-screen"></main>
    </div>

    <!-- Modal de Mensajes (para √©xito/error) -->
    <div id="modalMensaje" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-gray-900 rounded-xl shadow-xl w-full max-w-sm p-6 text-center">
            <h2 id="modalMensajeTitulo" class="text-2xl font-bold mb-4"></h2>
            <p id="modalMensajeContenido" class="mb-6 text-gray-300"></p>
            <button type="button" id="btnCerrarMensaje" class="px-5 py-2 bg-emerald-600 rounded-full hover:bg-emerald-700">Cerrar</button>
        </div>
    </div>

<script>
    const sidebar = document.getElementById('sidebar');
    const btnToggleSidebar = document.getElementById('btnToggleSidebar');
    const contenido = document.getElementById('contenido');
    const overlay = document.getElementById('overlay'); // Referencia al overlay

    const toggleServiciosSidebar = document.getElementById('toggleServiciosSidebar');
    const submenuServicios = document.getElementById('submenuServicios');
    const arrowIcon = document.getElementById('arrowIcon');

    const toggleTransaccionesSidebar = document.getElementById('toggleTransaccionesSidebar');
    const submenuTransacciones = document.getElementById('submenuTransacciones');
    const arrowIconTransacciones = document.getElementById('arrowIconTransacciones');

    // Datos de servicios con iconos SVG (sin monto predefinido)
    const serviciosData = {
        luz: {
            nombre: "Luz El√©ctrica",
            codigo: "0102839", 
            icono: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`
        },
        agua: {
            nombre: "Agua Potable",
            codigo: "0204911",
            icono: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21.5c-4.418 0-8-3.582-8-8 0-6 8-15 8-15s8 9 8 15c0 4.418-3.582 8-8 8zM12 18a4 4 0 100-8 4 4 0 000 8z" /></svg>`
        },
        internet: {
            nombre: "Internet Hogar",
            codigo: "0334588",
            icono: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>`
        },
        telefono: {
            nombre: "Tel√©fono M√≥vil",
            codigo: "0443022",
            icono: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4h4a2 2 0 002-2V8a2 2 0 00-2-2h-4a2 2 0 00-2 2v4a2 2 0 002 2z" /></svg>`
        }
    };

    // Funci√≥n para formatear a moneda de Guatemala
    function formatoMoneda(valor) {
        return new Intl.NumberFormat("es-GT", {
            style: "currency",
            currency: "GTQ",
            minimumFractionDigits: 2,
        }).format(valor);
    }

    // Funci√≥n para mostrar un modal de mensaje
    function mostrarMensaje(titulo, contenido, esError = false) {
        console.log("Mostrar Mensaje llamado. T√≠tulo:", titulo, "Contenido:", contenido);
        const modal = document.getElementById("modalMensaje");
        const modalTitulo = document.getElementById("modalMensajeTitulo");
        const modalContenido = document.getElementById("modalMensajeContenido");

        modalTitulo.textContent = titulo;
        modalContenido.textContent = contenido;

        if (esError) {
            modalTitulo.classList.remove("text-emerald-400");
            modalTitulo.classList.add("text-red-400");
        } else {
            modalTitulo.classList.remove("text-red-400");
            modalTitulo.classList.add("text-emerald-400");
        }
        modal.classList.remove("hidden");
    }

    // Cerrar modal de mensaje
    document.getElementById("btnCerrarMensaje").addEventListener("click", () => {
        console.log("Bot√≥n Cerrar Mensaje clickeado.");
        document.getElementById("modalMensaje").classList.add("hidden");
        
        // Determinar la secci√≥n actual para recargar los datos
        const activeLink = document.querySelector('.sidebar-link.bg-emerald-600');
        const activeSubmenuItem = document.querySelector('.submenu-item.bg-emerald-600');
        let currentSectionId = null;

        if (activeLink) {
            currentSectionId = activeLink.getAttribute('data-id');
        } else if (activeSubmenuItem) {
            currentSectionId = activeSubmenuItem.getAttribute('data-id');
        }

        // Forzar la recarga de la secci√≥n de inicio si estamos en ella
        if (currentSectionId === 'inicio') {
            console.warn("Forzando la reconstrucci√≥n completa del contenido de la secci√≥n de Inicio.");
            contenido.innerHTML = secciones.inicio; // Reemplaza todo el HTML de la secci√≥n de inicio
            inicializarInicio(); // Vuelve a inicializar los elementos y carga los datos
        } else if (currentSectionId === 'historial') {
            console.log("Recargando secci√≥n de Historial...");
            inicializarHistorial(); 
        }
    });


    // Definici√≥n de las secciones del contenido principal
    const secciones = {
        inicio: `
            <section class="max-w-6xl mx-auto min-h-[70vh] p-6 text-white">
                <h1 class="text-4xl font-bold mb-6 text-emerald-400 text-center">Bienvenido/a <span id="dashboardTitulo" class="text-white">a kinalBAnk</span></h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-2">Saldo principal</h2>
                        <p id="dashboardSaldoDisponible" class="text-4xl font-mono text-emerald-400">${formatoMoneda(0.00)}</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-2">√öltima actividad</h2>
                        <p class="text-sm text-gray-400" id="dashboardUltimaActividad">Cargando...</p>
                    </div>
                </div>

                <div id="ultimosMovimientosCard" class="bg-gray-800 rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-emerald-400 mb-4">√öltimos 5 Movimientos</h2>
                    <table class="w-full text-left">
                        <thead class="text-gray-300 border-b border-gray-700">
                            <tr>
                                <th class="py-2 px-3">Fecha</th>
                                <th class="py-2 px-3">Descripci√≥n</th>
                                <th class="py-2 px-3">Cuenta</th>
                                <th class="py-2 px-3">Tipo</th>
                                <th class="py-2 px-3">Monto</th>
                            </tr>
                        </thead>
                        <tbody id="ultimosMovimientosTableBody" class="text-gray-100">
                            <tr><td colspan="5" class="p-3 text-center text-gray-400">Cargando √∫ltimos movimientos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        `,

        miCuenta: `
            <section class="max-w-6xl mx-auto min-h-[70vh] p-6 text-white">
                <h1 class="text-4xl font-bold mb-6 text-emerald-400">Mi Cuenta</h1>
                <div id="cuentasContainer" class="grid md:grid-cols-2 gap-6">
                    <p class="text-gray-400 text-center col-span-2">Cargando cuenta...</p>
                </div>
            </section>
        `,
        transferenciasInternas: `
            <section class="max-w-xl mx-auto min-h-[70vh] p-6 text-white">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-emerald-400 mb-4 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-emerald-400 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                        Transferencia entre mis cuentas
                    </h2>
                    <p class="text-lg text-gray-300 mb-6 text-center">Transfiere dinero entre tus propias cuentas (funcionalidad limitada con una sola cuenta).</p>
                    
                    <form id="formTransferenciaInterna" class="space-y-4">
                        <div>
                            <label for="cuentaOrigenInterna" class="block font-semibold mb-1">Cuenta de origen:</label>
                            <select id="cuentaOrigenInterna" name="cuentaOrigenInterna" class="w-full bg-gray-700 text-white p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                                <option value="" disabled selected>Selecciona una cuenta</option>
                            </select>
                        </div>
                        <div>
                            <label for="cuentaDestinoInterna" class="block font-semibold mb-1">Cuenta destino:</label>
                            <select id="cuentaDestinoInterna" name="cuentaDestinoInterna" class="w-full bg-gray-700 text-white p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                                <option value="" disabled selected>Selecciona una cuenta</option>
                            </select>
                        </div>
                        <div>
                            <label for="montoTransferenciaInterna" class="block font-semibold mb-1">Monto a transferir (GTQ):</label>
                            <input type="number" id="montoTransferenciaInterna" name="montoTransferenciaInterna" min="0.01" step="0.01" placeholder="Ej. 150.00" class="w-full p-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" required />
                        </div>
                        <div>
                            <label for="descripcionTransferenciaInterna" class="block font-semibold mb-1">Descripci√≥n (opcional):</label>
                            <input type="text" id="descripcionTransferenciaInterna" name="descripcionTransferenciaInterna" placeholder="Ej. Pago de factura" class="w-full p-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" />
                        </div>
                        <button type="submit" class="w-full mt-4 bg-emerald-600 hover:bg-emerald-700 p-3 rounded-full font-bold shadow-lg transition focus:outline-none focus:ring-2 focus:ring-emerald-400">
                            Realizar Transferencia
                        </button>
                        <p id="mensajeTransferenciaInterna" class="mt-4 text-center"></p>
                    </form>
                </div>
            </section>
        `,
        transferenciasOtrosUsuarios: `
            <section class="max-w-xl mx-auto min-h-[70vh] p-6 text-white">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-emerald-400 mb-4 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-emerald-400 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                        Transferencia a otro usuario
                    </h2>
                    <p class="text-lg text-gray-300 mb-6 text-center">Transfiere dinero a cuentas de otros usuarios en kinalBAnk.</p>
                    
                    <form id="formTransferenciaOtroUsuario" class="space-y-4">
                        <div>
                            <label for="cuentaOrigenOtroUsuario" class="block font-semibold mb-1">Cuenta de origen:</label>
                            <select id="cuentaOrigenOtroUsuario" name="cuentaOrigenOtroUsuario" class="w-full bg-gray-700 text-white p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                                <option value="" disabled selected>Selecciona tu cuenta de origen</option>
                            </select>
                        </div>
                        
                        <div class="flex items-end space-x-2">
                            <div class="flex-grow">
                                <label for="numeroCuentaDestinoBusqueda" class="block font-semibold mb-1">N√∫mero de cuenta destino:</label>
                                <input type="text" id="numeroCuentaDestinoBusqueda" name="numeroCuentaDestinoBusqueda" placeholder="Ej. 123456789012" class="w-full p-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" required />
                            </div>
                            <button type="button" id="btnBuscarCuentaDestino" class="bg-blue-600 hover:bg-blue-700 p-3 rounded-md font-bold shadow-lg transition focus:outline-none focus:ring-2 focus:ring-blue-400 h-full">
                                Buscar
                            </button>
                        </div>

                        <div id="datosCuentaDestino" class="space-y-3 bg-gray-700 p-4 rounded-md hidden">
                            <h3 class="text-xl font-semibold text-emerald-300">Detalles de la Cuenta de Destino:</h3>
                            <div>
                                <label class="block mb-1 text-sm text-gray-300">Nombre del Titular:</label>
                                <input type="text" id="nombreTitularDestino" class="w-full p-2 rounded bg-gray-600 text-white cursor-not-allowed" readonly />
                            </div>
                            <div>
                                <label class="block mb-1 text-sm text-gray-300">Apellido del Titular:</label>
                                <input type="text" id="apellidoTitularDestino" class="w-full p-2 rounded bg-gray-600 text-white cursor-not-allowed" readonly />
                            </div>
                            <div>
                                <label class="block mb-1 text-sm text-gray-300">Tipo de Cuenta:</label>
                                <input type="text" id="tipoCuentaDestino" class="w-full p-2 rounded bg-gray-600 text-white cursor-not-allowed" readonly />
                            </div>
                        </div>

                        <div>
                            <label for="montoTransferenciaOtroUsuario" class="block font-semibold mb-1">Monto a transferir (GTQ):</label>
                            <input type="number" id="montoTransferenciaOtroUsuario" name="montoTransferenciaOtroUsuario" min="0.01" step="0.01" placeholder="Ej. 150.00" class="w-full p-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" required />
                        </div>
                        <div>
                            <label for="descripcionTransferenciaOtroUsuario" class="block font-semibold mb-1">Descripci√≥n (opcional):</label>
                            <input type="text" id="descripcionTransferenciaOtroUsuario" name="descripcionTransferenciaOtroUsuario" placeholder="Ej. Pago de factura" class="w-full p-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" />
                        </div>
                        <button type="submit" id="btnConfirmarTransferenciaOtroUsuario" class="w-full mt-4 bg-emerald-600 hover:bg-emerald-700 p-3 rounded-full font-bold shadow-lg transition focus:outline-none focus:ring-2 focus:ring-emerald-400">
                            Realizar Transferencia
                        </button>
                        <p id="mensajeTransferenciaOtroUsuario" class="mt-4 text-center"></p>
                    </form>
                </div>
            </section>
        `,
        historial: `
            <section class="max-w-6xl mx-auto min-h-[70vh] p-6 text-white">
                <h1 class="text-3xl font-bold mb-6 text-emerald-400">Historial de Movimientos</h1>
                <div class="flex flex-wrap gap-4 mb-6 items-end">
                    <div>
                        <label for="fechaInicio" class="block text-gray-300 text-sm mb-1">Fecha Inicio:</label>
                        <input type="date" id="fechaInicio" class="px-3 py-2 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500" />
                    </div>
                    <div>
                        <label for="fechaFin" class="block text-gray-300 text-sm mb-1">Fecha Fin:</label>
                        <input type="date" id="fechaFin" class="px-3 py-2 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500" />
                    </div>
                    <div>
                        <label for="tipoMovimiento" class="block text-gray-300 text-sm mb-1">Tipo:</label>
                        <select id="tipoMovimiento" class="px-3 py-2 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="todos">Todos</option>
                            <option value="ingreso">Ingreso</option>
                            <option value="egreso">Egreso</option>
                        </select>
                    </div>
                    <button id="btnFiltrar" class="bg-emerald-600 px-4 py-2 rounded-full hover:bg-emerald-700 transition self-end focus:outline-none focus:ring-2 focus:ring-emerald-400">
                        Filtrar
                    </button>
                    <button id="btnReportesHistorial" class="bg-blue-600 px-4 py-2 rounded-full hover:bg-blue-700 transition self-end focus:outline-none focus:ring-2 focus:ring-blue-400">
                        Reporter√≠a
                    </button>
                </div>
                <table class="w-full bg-gray-800 rounded-lg overflow-hidden shadow-lg">
                    <thead class="bg-gray-700 text-gray-300">
                        <tr>
                            <th class="py-3 px-4 text-left">Fecha</th>
                            <th class="py-3 px-4 text-left">Descripci√≥n</th>
                            <th class="py-3 px-4 text-left">Cuenta</th>
                            <th class="py-3 px-4 text-left">Tipo</th>
                            <th class="py-3 px-4 text-left">Monto</th>
                        </tr>
                    </thead>
                    <tbody id="tablaMovimientos" class="text-gray-100">
                    </tbody>
                </table>
            </section>
        `,
        servicioDetalle: (serviceId) => {
            const service = serviciosData[serviceId];
            if (!service) return `<p class="text-center text-red-400">Servicio no encontrado.</p>`;
            return `
                <section class="max-w-xl mx-auto min-h-[70vh] p-6 text-white">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h2 class="text-3xl font-bold text-emerald-400 mb-4 flex items-center justify-center">
                            ${service.icono.replace('h-6 w-6', 'h-10 w-10').replace('mr-2', 'mr-3')} <span class="ml-3">Pago de ${service.nombre}</span>
                        </h2>
                        <p class="text-lg text-gray-300 mb-6 text-center">Ingresa los detalles del pago para ${service.nombre}.</p>
                        
                        <form id="formPagoServicio" class="space-y-4">
                            <div>
                                <label for="codigoServicio" class="block font-semibold mb-1">C√≥digo del Servicio:</label>
                                <input type="text" id="codigoServicio" name="codigoServicio" value="${service.codigo}" class="w-full p-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" readonly />
                            </div>
                            <div>
                                <label for="montoPagar" class="block font-semibold mb-1">Monto a pagar (GTQ):</label>
                                <input type="number" id="montoPagar" name="montoPagar" min="0.01" step="0.01" placeholder="Ej. 150.75" class="w-full p-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" required />
                            </div>
                            <div>
                                <label for="cuentaOrigenServicio" class="block font-semibold mb-1">Cuenta de origen:</label>
                                <select id="cuentaOrigenServicio" name="cuentaOrigenServicio" class="w-full bg-gray-700 text-white p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                                    <option value="" disabled selected>Selecciona una cuenta</option>
                                </select>
                            </div>
                            <div>
                                <label for="descripcionPago" class="block font-semibold mb-1">Descripci√≥n (opcional):</label>
                                <input type="text" id="descripcionPago" name="descripcionPago" placeholder="Mes de [Mes], Factura [N√∫mero]" class="w-full p-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" />
                            </div>
                            <div class="flex flex-col sm:flex-row justify-center gap-4 mt-6">
                                <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 px-6 py-3 rounded-full text-white font-bold shadow-lg transition focus:outline-none focus:ring-2 focus:ring-emerald-400">
                                    Realizar Pago
                                </button>
                                <button type="button" id="btnVolverServicios" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-full text-white font-bold shadow-lg transition focus:outline-none focus:ring-2 focus:ring-gray-400">
                                    Volver a Servicios
                                </button>
                            </div>
                            <p id="mensajePagoServicio" class="mt-4 text-center"></p>
                        </form>
                    </div>
                </section>
            `;
        },

        cerrarSesion: `
            <section class="max-w-6xl mx-auto min-h-[70vh] p-6 text-white text-center flex flex-col items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-500 mb-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7" />
                </svg>
                <h1 class="text-3xl font-bold mb-4 text-emerald-400">¬øSeguro que deseas cerrar sesi√≥n?</h1>
                <button id="confirmCerrarSesion" class="bg-red-600 hover:bg-red-700 px-8 py-3 rounded-full shadow-lg font-semibold transition focus:outline-none focus:ring-2 focus:ring-red-400">Cerrar sesi√≥n</button>
            </section>
        `
    };

    let userAccounts = []; // Variable para almacenar las cuentas del usuario
    let foundDestinationAccount = null; // Variable global para almacenar la cuenta de destino encontrada

    /**
     * Muestra la secci√≥n de contenido principal y actualiza la UI de la barra lateral.
     * @param {string} id - El ID de la secci√≥n principal a mostrar (ej. 'inicio', 'historial').
     * @param {string} [subId=null] - El ID del sub-servicio si la secci√≥n es 'servicioDetalle'.
     */
    function mostrarSeccion(id, subId = null) {
        console.log("Mostrando secci√≥n:", id, "SubId:", subId);
        // Carga el contenido de la secci√≥n
        if (id === 'servicioDetalle' && subId) {
            contenido.innerHTML = secciones.servicioDetalle(subId);
            inicializarServicioDetalle(subId);
        } else {
            contenido.innerHTML = secciones[id] || `<p class="text-center mt-20 text-gray-400">Secci√≥n no disponible.</p>`;
            // Inicializa funciones espec√≠ficas de cada secci√≥n
            if (id === 'historial') inicializarHistorial();
            if (id === 'transferenciasInternas') inicializarTransferenciasInternas();
            if (id === 'transferenciasOtrosUsuarios') inicializarTransferenciasOtrosUsuarios();
            if (id === 'inicio') inicializarInicio(); 
            if (id === 'miCuenta') inicializarMiCuenta();
            if (id === 'cerrarSesion') { // Agregamos el listener para cerrar sesi√≥n
                document.getElementById('confirmCerrarSesion').addEventListener('click', () => {
                    window.location.href = `${window.location.origin}/logout`; // URL absoluta para logout
                });
            }
        }
        
        // L√≥gica para ocultar el men√∫ y el bot√≥n cuando se selecciona una opci√≥n
        sidebar.classList.add('-translate-x-full'); // Oculta el sidebar
        overlay.classList.add('hidden'); // Oculta el overlay
        contenido.classList.remove('con-sidebar-visible'); // Quita el margen del contenido
        btnToggleSidebar.style.display = 'block'; // Asegura que el bot√≥n sea visible cuando el sidebar est√° oculto

        // Desactivar todos los links de la sidebar y del submen√∫
        document.querySelectorAll(".sidebar-link").forEach(l =>
            l.classList.remove("bg-emerald-600", "text-white")
        );
        document.querySelectorAll(".submenu-item").forEach(l =>
            l.classList.remove("bg-emerald-600", "text-white")
        );

        // Activar el link correspondiente
        if (!subId) { // Es un enlace de nivel superior (Inicio, Mi Cuenta, etc.)
            const currentLink = document.querySelector(`.sidebar-link[data-id="${id}"]`);
            if (currentLink) currentLink.classList.add("bg-emerald-600", "text-white");
            // Asegurarse de que los submen√∫s se colapsen si se selecciona otra secci√≥n principal
            if (!submenuServicios.classList.contains('hidden')) {
                submenuServicios.classList.add('hidden');
                arrowIcon.classList.remove('rotate-180');
            }
            if (!submenuTransacciones.classList.contains('hidden')) {
                submenuTransacciones.classList.add('hidden');
                arrowIconTransacciones.classList.remove('rotate-180');
            }
        } else { // Es un sub-item (un servicio espec√≠fico o tipo de transacci√≥n)
            const currentSubItem = document.querySelector(`.submenu-item[data-id="${id}"]`); // Cambiado a data-id para transacciones
            if (currentSubItem) {
                currentSubItem.classList.add("bg-emerald-600", "text-white");
            }

            // Activar la pesta√±a padre correspondiente
            if (id.startsWith('transferencias')) { // Ahora solo hay transferencias internas y a otros usuarios
                toggleTransaccionesSidebar.classList.add("bg-emerald-600", "text-white");
                if (submenuTransacciones.classList.contains('hidden')) {
                    submenuTransacciones.classList.remove('hidden');
                    arrowIconTransacciones.classList.add('rotate-180');
                }
            } else if (id === 'servicioDetalle') { // Esto manejar√° los pagos de servicios
                const currentServiceSubItem = document.querySelector(`.submenu-item[data-service-id="${subId}"]`);
                if (currentServiceSubItem) currentServiceSubItem.classList.add("bg-emerald-600", "text-white");
                toggleServiciosSidebar.classList.add("bg-emerald-600", "text-white"); 
                if (submenuServicios.classList.contains('hidden')) {
                    submenuServicios.classList.remove('hidden');
                    arrowIcon.classList.add('rotate-180');
                }
            }
        }
    }

    /**
     * Rellena una tabla HTML con los datos de movimientos.
     * @param {Array<Object>} datos - Array de objetos de movimiento.
     * @param {string} targetId - ID del tbody donde se insertar√°n las filas.
     */
    function pintarTablaMovimientos(datos, targetId = 'tablaMovimientos') {
        const tabla = document.getElementById(targetId);
        if (!tabla) {
            console.error(`Elemento con ID ${targetId} no encontrado.`);
            return;
        }

        console.log(`[${targetId}] Datos recibidos (antes de ordenar):`, datos);

        // Clear previous content
        while (tabla.firstChild) {
            tabla.removeChild(tabla.firstChild);
        }
        console.log(`[${targetId}] Contenido de la tabla limpiado.`);


        if (datos.length === 0) {
            const noDataRow = document.createElement('tr');
            noDataRow.innerHTML = '<td colspan="5" class="p-3 text-center text-gray-400">No hay movimientos para mostrar.</td>';
            tabla.appendChild(noDataRow);
            console.log(`[${targetId}] No hay movimientos, mensaje de "no hay" insertado.`);
            return;
        }

        // Ordenar los datos por fecha descendente (m√°s reciente primero)
        // Y si las fechas son iguales, ordenar por ID descendente para consistencia
        datos.sort((a, b) => {
            const dateA = new Date(a.date);
            const dateB = new Date(b.date);

            // Compara las fechas
            if (dateB.getTime() !== dateA.getTime()) {
                return dateB.getTime() - dateA.getTime(); // Ordenar por fecha descendente
            }

            // Si las fechas son iguales, ordenar por ID descendente (asumiendo que mayor ID es m√°s reciente)
            return b.id - a.id; 
        });

        console.log(`[${targetId}] Datos (despu√©s de ordenar):`, datos);

        datos.forEach(mov => {
            const capitalizeFirstLetter = (string) => {
                if (!string) return '';
                return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
            };

            const tipoDisplay = capitalizeFirstLetter(mov.type); 
            const amountClass = mov.type === 'INCOME' ? 'text-green-400' : 'text-red-400';
            const amountSign = mov.type === 'INCOME' ? '+' : '-'; 

            let descriptionDisplay = mov.description;

            // L√≥gica para enriquecer la descripci√≥n de transferencias
            // Asumimos que el backend puede enviar `transferOriginAccount` y `transferDestinationAccount`
            if (mov.description && mov.description.includes('Transferencia')) {
                if (mov.type === 'EXPENSE' && mov.transferDestinationAccount) {
                    descriptionDisplay = `Transferencia a: ${mov.transferDestinationAccount}`;
                } else if (mov.type === 'INCOME' && mov.transferOriginAccount) {
                    descriptionDisplay = `Transferencia por: ${mov.transferOriginAccount}`;
                }
            }
            // Si el backend ya env√≠a la descripci√≥n completa (ej. "Transferencia a: C002"),
            // y no proporciona los campos `transferOriginAccount`/`transferDestinationAccount`
            // o si la descripci√≥n no incluye "Transferencia", entonces `descriptionDisplay`
            // se mantendr√° como `mov.description` original.


            const row = document.createElement('tr');
            row.className = 'border-t border-gray-700 hover:bg-gray-700 transition';
            row.innerHTML = `
                <td class="py-3 px-4">${mov.date}</td>
                <td class="py-3 px-4">${descriptionDisplay}</td>
                <td class="py-3 px-4">${mov.accountNumber || 'N/A'}</td>
                <td class="py-3 px-4">${tipoDisplay}</td>
                <td class="py-3 px-4 ${amountClass}">
                    ${amountSign}${formatoMoneda(Math.abs(mov.amount))}
                </td>
            `;
            tabla.appendChild(row);
        });
        console.log(`[${targetId}] Nuevo contenido HTML insertado.`);
    }

    /**
     * Rellena un select de HTML con las cuentas del usuario.
     * @param {string} selectId - ID del select a rellenar.
     * @param {boolean} includeDefaultOption - Si se debe incluir la opci√≥n por defecto "Selecciona una cuenta".
     * @param {string|null} excludeAccountNumber - N√∫mero de cuenta a excluir (para transferencias internas).
     */
    function populateAccountSelect(selectId, includeDefaultOption = true, excludeAccountNumber = null) {
        const selectElement = document.getElementById(selectId);
        if (!selectElement) return;

        selectElement.innerHTML = ''; // Limpiar opciones previas
        if (includeDefaultOption) {
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Selecciona una cuenta';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            selectElement.appendChild(defaultOption);
        }

        if (userAccounts.length === 0) {
            const noAccountsOption = document.createElement('option');
            noAccountsOption.value = '';
            noAccountsOption.textContent = 'No hay cuentas disponibles';
            noAccountsOption.disabled = true;
            selectElement.appendChild(noAccountsOption);
            return;
        }

        userAccounts.forEach(account => {
            if (excludeAccountNumber && account.accountNumber === excludeAccountNumber) {
                return; // Saltar la cuenta si debe ser excluida
            }
            const option = document.createElement('option');
            option.value = account.accountNumber;
            // Ahora que solo hay una cuenta, la descripci√≥n es m√°s simple
            option.textContent = `${account.accountType} (${account.accountNumber}) - Saldo: ${formatoMoneda(account.balance)}`;
            selectElement.appendChild(option);
        });
    }

    /**
     * Carga las cuentas del usuario desde el backend y las almacena.
     * @returns {Promise<Array>} Una promesa que resuelve con el array de cuentas.
     */
    async function cargarCuentasUsuario() {
        console.log("Cargando cuentas de usuario...");
        try {
            const response = await fetch(`${window.location.origin}/api/accounts/me`, { cache: 'no-store' }); // URL absoluta
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    window.location.href = `${window.location.origin}/login`; // URL absoluta
                    throw new Error('No autenticado');
                }
                throw new Error('Error al obtener las cuentas del usuario.');
            }
            userAccounts = await response.json();
            console.log("Cuentas de usuario cargadas:", userAccounts);
            return userAccounts;
        } catch (error) {
            console.error('Error al cargar las cuentas:', error);
            userAccounts = []; // Limpiar en caso de error
            return [];
        }
    }

    /**
     * Carga los √∫ltimos 5 movimientos del usuario para el dashboard.
     */
    async function cargarUltimosMovimientos() {
        console.log("Cargando √∫ltimos 5 movimientos para el dashboard...");
        const ultimosMovimientosTableBody = document.getElementById('ultimosMovimientosTableBody');
        if (!ultimosMovimientosTableBody) return;

        // Limpiar la tabla antes de cargar nuevos datos
        while (ultimosMovimientosTableBody.firstChild) {
            ultimosMovimientosTableBody.removeChild(ultimosMovimientosTableBody.firstChild);
        }
        ultimosMovimientosTableBody.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-gray-400">Cargando √∫ltimos movimientos...</td></tr>';

        try {
            // Endpoint para obtener el historial de movimientos con un l√≠mite de 5
            const cacheBuster = new Date().getTime(); // Par√°metro √∫nico para evitar cach√©
            const url = `${window.location.origin}/api/movements/history?limit=5&_=${cacheBuster}`; // URL absoluta
            
            const response = await fetch(url, { cache: 'no-store' }); // Forzar no cach√©
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    window.location.href = `${window.location.origin}/login`; // URL absoluta
                    throw new Error('No autenticado');
                }
                throw new Error('Error al obtener los √∫ltimos movimientos.');
            }
            const movimientos = await response.json();
            console.log("Movimientos recibidos para dashboard (con anti-cach√©):", movimientos);
            pintarTablaMovimientos(movimientos, 'ultimosMovimientosTableBody');
            
            // Actualizar "√öltima actividad"
            const dashboardUltimaActividad = document.getElementById('dashboardUltimaActividad');
            if (dashboardUltimaActividad && movimientos.length > 0) {
                const ultimoMovimiento = movimientos[0]; // Ya est√° ordenado por fecha descendente
                dashboardUltimaActividad.textContent = `${ultimoMovimiento.date}: ${ultimoMovimiento.description} (${formatoMoneda(Math.abs(ultimoMovimiento.amount))})`;
            } else if (dashboardUltimaActividad) {
                dashboardUltimaActividad.textContent = 'No hay actividad reciente.';
            }

        } catch (error) {
            console.error('Error al cargar √∫ltimos movimientos:', error);
            ultimosMovimientosTableBody.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-red-400">Error al cargar √∫ltimos movimientos.</td></tr>';
            const dashboardUltimaActividad = document.getElementById('dashboardUltimaActividad');
            if (dashboardUltimaActividad) dashboardUltimaActividad.textContent = 'Error al cargar actividad.';
        }
    }


    /**
     * Inicializa la secci√≥n de inicio, mostrando los datos del user y los √∫ltimos 5 movimientos.
     */
    async function inicializarInicio() {
        console.log("Inicializando secci√≥n de Inicio...");
        // Cargar datos del user (nombre y saldo principal)
        try {
            const cacheBuster = new Date().getTime();
            const response = await fetch(`${window.location.origin}/api/dashboard/me?_=${cacheBuster}`, { cache: 'no-store' }); // URL absoluta
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    window.location.href = `${window.location.origin}/login`; // URL absoluta
                    return Promise.reject('No autenticado');
                }
                throw new Error('Error al obtener los datos del user.');
            }
            const data = await response.json();
            console.log("Datos de dashboard recibidos (con anti-cach√©):", data);
            const dashboardTitulo = document.getElementById('dashboardTitulo');
            if (dashboardTitulo) {
                dashboardTitulo.textContent = data.fullName;
            }
            const saldoPrincipalElem = document.getElementById('dashboardSaldoDisponible');
            if (saldoPrincipalElem) {
                saldoPrincipalElem.textContent = formatoMoneda(data.totalBalance);
            }
        } catch (error) {
            console.error('Error al cargar datos del dashboard:', error);
            const dashboardTitulo = document.getElementById('dashboardTitulo');
            if (dashboardTitulo) dashboardTitulo.textContent = 'Usuario'; // Fallback
            const saldoPrincipalElem = document.getElementById('dashboardSaldoDisponible');
            if (saldoPrincipalElem) saldoPrincipalElem.textContent = formatoMoneda(0); // Fallback
        }

        // Llamar a la funci√≥n para cargar los √∫ltimos movimientos
        cargarUltimosMovimientos();
    }
    /**
     * Inicializa la secci√≥n "Mi cuenta", cargando las cuentas del user desde el backend.
     */
    async function inicializarMiCuenta() {
        console.log("Inicializando secci√≥n Mi Cuenta...");
        const cuentasContainer = document.getElementById('cuentasContainer');
        if (!cuentasContainer) return;

        cuentasContainer.innerHTML = `<p class="text-gray-400 text-center col-span-2">Cargando cuenta...</p>`; // Mensaje de carga

        try {
            const cacheBuster = new Date().getTime();
            const response = await fetch(`${window.location.origin}/api/dashboard/accounts?_=${cacheBuster}`, { cache: 'no-store' }); // URL absoluta
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    window.location.href = `${window.location.origin}/login`; // URL absoluta
                    throw new Error('No autenticado');
                }
                throw new Error('Error al obtener las cuentas del usuario.');
            }
            const cuentas = await response.json(); // userAccounts ya no es global aqu√≠, sino local
            console.log("Cuentas para Mi Cuenta (con anti-cach√©):", cuentas);

            cuentasContainer.innerHTML = ''; // Limpiar el mensaje de carga

            if (cuentas.length === 0) {
                cuentasContainer.innerHTML = `<p class="text-gray-400 text-center col-span-2">No tienes cuentas asociadas.</p>`;
                return;
            }

            // Con una sola cuenta por usuario, mostramos solo la primera (o la √∫nica)
            const cuenta = cuentas[0]; 
            const cuentaCard = `
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-lg text-gray-300 mb-2">Cuenta ${cuenta.accountType.toLowerCase()}</h2>
                    <p class="text-emerald-400 text-3xl font-mono">${formatoMoneda(cuenta.balance)}</p>
                    <p class="text-gray-400 mt-1">No. ${cuenta.accountNumber}</p>
                    <span class="text-xs ${cuenta.status === 'ACTIVA' ? 'text-green-500' : 'text-red-500'} uppercase">${cuenta.status}</span>
                </div>
            `;
            cuentasContainer.innerHTML += cuentaCard;
            
            userAccounts = cuentas; // Asegurarse de que userAccounts global se actualice para otros selects
        } catch (error) {
            console.error('Error al cargar las cuentas:', error);
            cuentasContainer.innerHTML = `<p class="text-red-400 text-center col-span-2">Error al cargar la cuenta.</p>`;
        }
    }

    /**
     * Inicializa la secci√≥n de Transferencia Interna (entre cuentas del mismo usuario).
     * Nota: Con una sola cuenta por usuario, esta funcionalidad es limitada.
     */
    async function inicializarTransferenciasInternas() {
        console.log("Inicializando secci√≥n Transferencias Internas...");
        const form = document.getElementById('formTransferenciaInterna');
        const mensaje = document.getElementById('mensajeTransferenciaInterna');
        const cuentaOrigenSelect = document.getElementById('cuentaOrigenInterna');
        const cuentaDestinoSelect = document.getElementById('cuentaDestinoInterna');

        if (!form) return;

        await cargarCuentasUsuario();
        populateAccountSelect('cuentaOrigenInterna');
        populateAccountSelect('cuentaDestinoInterna'); // Se poblar√° inicialmente con todas las cuentas

        // L√≥gica para que la cuenta destino no pueda ser la misma que la de origen
        cuentaOrigenSelect.addEventListener('change', () => {
            populateAccountSelect('cuentaDestinoInterna', true, cuentaOrigenSelect.value);
        });

        form.onsubmit = async e => {
            e.preventDefault();
            const originAccountNumber = cuentaOrigenSelect.value;
            const destinationAccountNumber = cuentaDestinoSelect.value;
            const amount = parseFloat(form.montoTransferenciaInterna.value);
            const description = form.descripcionTransferenciaInterna.value.trim();

            if (!originAccountNumber || !destinationAccountNumber || isNaN(amount) || amount <= 0) {
                mostrarMensaje('Error', 'Por favor complete todos los campos correctamente.', true);
                return;
            }

            if (originAccountNumber === destinationAccountNumber) {
                mostrarMensaje('Error', 'La cuenta de origen y la de destino no pueden ser la misma.', true);
                return;
            }

            // Validar saldo
            const selectedOriginAccount = userAccounts.find(acc => acc.accountNumber === originAccountNumber);
            if (selectedOriginAccount && amount > selectedOriginAccount.balance) {
                mostrarMensaje("Error", `Saldo insuficiente en la cuenta de origen. Su saldo actual es: ${formatoMoneda(selectedOriginAccount.balance)}.`, true);
                return;
            }

            try {
                const response = await fetch(`${window.location.origin}/api/transactions/transfer`, { // URL absoluta
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        originAccountNumber: originAccountNumber,
                        destinationAccountNumber: destinationAccountNumber,
                        amount: amount,
                        description: description
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    mostrarMensaje("Error", data.message || 'Error al realizar la transferencia interna.', true);
                    return;
                }

                let newOriginBalance = null;
                if (data.movements && data.movements.length > 0) {
                    const originMovement = data.movements.find(mov => mov.accountNumber === originAccountNumber);
                    if (originMovement && originMovement.balance !== undefined) {
                        newOriginBalance = originMovement.balance;
                    }
                }

                const balanceMessage = newOriginBalance !== null ? ` Nuevo saldo de origen: ${formatoMoneda(newOriginBalance)}` : '';
                mostrarMensaje("√âxito", `Transferencia de ${formatoMoneda(amount)} de ${originAccountNumber} a ${destinationAccountNumber} realizada con √©xito.${balanceMessage}`);
                form.reset();
                await cargarCuentasUsuario(); // Recargar cuentas para actualizar saldos
                populateAccountSelect('cuentaOrigenInterna');
                populateAccountSelect('cuentaDestinoInterna');
            } catch (error) {
                console.error('Error al realizar la transferencia interna:', error);
                mostrarMensaje("Error", `Error: ${error.message}`, true);
            }
        };
    }

    // Funci√≥n para buscar una cuenta por su n√∫mero (reutilizada del admin)
    async function buscarCuentaPorNumero(accountNumber) {
        try {
            const response = await fetch(`${window.location.origin}/api/accounts/number/${accountNumber}`); // Usar URL absoluta
            if (!response.ok) {
                console.error(`Error de respuesta para /api/accounts/number/${accountNumber}: Estado ${response.status}, Mensaje: ${response.statusText}`);
                if (response.status === 404) {
                    mostrarMensaje("Error", `Cuenta con n√∫mero ${accountNumber} no encontrada.`, true);
                } else if (response.status === 401 || response.status === 403) {
                    window.location.href = `${window.location.origin}/login`; // Usar URL absoluta
                    throw new Error('No autenticado');
                } else {
                    throw new Error('Error al buscar la cuenta. Intente de nuevo.');
                }
            }
            const accountData = await response.json();
            return accountData;
        } catch (error) {
            console.error('Error al buscar cuenta:', error);
            mostrarMensaje("Error", `No se pudo buscar la cuenta: ${error.message}`, true);
            return null;
        }
    }

    /**
     * Inicializa la secci√≥n de Transferencia a otros usuarios del banco.
     * Esta es la principal funci√≥n de env√≠o de dinero.
     */
    async function inicializarTransferenciasOtrosUsuarios() {
        console.log("Inicializando secci√≥n Transferencias a Otros Usuarios...");
        const form = document.getElementById('formTransferenciaOtroUsuario');
        const mensaje = document.getElementById('mensajeTransferenciaOtroUsuario');
        const cuentaOrigenSelect = document.getElementById('cuentaOrigenOtroUsuario');
        const numeroCuentaDestinoBusquedaInput = document.getElementById('numeroCuentaDestinoBusqueda'); // Input de b√∫squeda
        const btnBuscarCuentaDestino = document.getElementById('btnBuscarCuentaDestino'); // Bot√≥n de b√∫squeda
        const datosCuentaDestinoDiv = document.getElementById('datosCuentaDestino'); // Div para mostrar datos
        const nombreTitularDestinoInput = document.getElementById('nombreTitularDestino');
        const apellidoTitularDestinoInput = document.getElementById('apellidoTitularDestino');
        const tipoCuentaDestinoInput = document.getElementById('tipoCuentaDestino');
        const montoTransferenciaOtroUsuarioInput = document.getElementById('montoTransferenciaOtroUsuario');
        const descripcionTransferenciaOtroUsuarioInput = document.getElementById('descripcionTransferenciaOtroUsuario');
        const btnConfirmarTransferenciaOtroUsuario = document.getElementById('btnConfirmarTransferenciaOtroUsuario');


        if (!form) return;

        // Limpiar y ocultar datos de destino al inicio
        datosCuentaDestinoDiv.classList.add('hidden');
        nombreTitularDestinoInput.value = '';
        apellidoTitularDestinoInput.value = '';
        tipoCuentaDestinoInput.value = '';
        foundDestinationAccount = null; // Reiniciar la cuenta de destino encontrada

        await cargarCuentasUsuario();
        populateAccountSelect('cuentaOrigenOtroUsuario'); // Solo se necesita poblar la cuenta de origen del usuario actual

        // Evento para el bot√≥n de b√∫squeda de cuenta de destino
        if (btnBuscarCuentaDestino) {
            btnBuscarCuentaDestino.onclick = async () => {
                const accountNumber = numeroCuentaDestinoBusquedaInput.value.trim();
                if (!accountNumber) {
                    mostrarMensaje("Advertencia", 'Por favor, ingrese un n√∫mero de cuenta de destino.', true);
                    return;
                }

                // Limpiar y ocultar datos de destino antes de una nueva b√∫squeda
                datosCuentaDestinoDiv.classList.add('hidden');
                nombreTitularDestinoInput.value = '';
                apellidoTitularDestinoInput.value = '';
                tipoCuentaDestinoInput.value = '';
                foundDestinationAccount = null;

                // Validar que la cuenta de destino no sea la misma que la de origen seleccionada
                const selectedOriginAccNum = cuentaOrigenSelect.value;
                if (selectedOriginAccNum && accountNumber === selectedOriginAccNum) {
                    mostrarMensaje("Error", "No puede transferir a su propia cuenta de origen.", true);
                    return;
                }

                const account = await buscarCuentaPorNumero(accountNumber); // Reutilizamos la funci√≥n de b√∫squeda
                if (account) {
                    foundDestinationAccount = account; // Almacenar la cuenta encontrada
                    nombreTitularDestinoInput.value = account.userName || 'N/A';
                    apellidoTitularDestinoInput.value = account.userLastName || 'N/A';
                    tipoCuentaDestinoInput.value = account.accountType || 'N/A';
                    datosCuentaDestinoDiv.classList.remove('hidden'); // Mostrar los datos
                    if (mensaje) mensaje.textContent = ''; // Limpiar mensaje de √©xito/error previo
                } else {
                    // buscarCuentaPorNumero ya muestra el mensaje de error
                    datosCuentaDestinoDiv.classList.add('hidden'); // Asegurarse de que est√© oculto
                }
            };
        }

        // Opcional: B√∫squeda "on-the-fly" mientras se escribe (con debounce)
        let debounceTimeout;
        if (numeroCuentaDestinoBusquedaInput) {
            numeroCuentaDestinoBusquedaInput.addEventListener('input', () => {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(async () => {
                    const accountNumber = numeroCuentaDestinoBusquedaInput.value.trim();
                    // Solo buscar si la longitud es razonable para evitar b√∫squedas excesivas
                    if (accountNumber.length >= 6) { 
                        // Limpiar y ocultar datos de destino antes de una nueva b√∫squeda
                        datosCuentaDestinoDiv.classList.add('hidden');
                        nombreTitularDestinoInput.value = '';
                        apellidoTitularDestinoInput.value = '';
                        tipoCuentaDestinoInput.value = '';
                        foundDestinationAccount = null;

                        // Validar que la cuenta de destino no sea la misma que la de origen seleccionada
                        const selectedOriginAccNum = cuentaOrigenSelect.value;
                        if (selectedOriginAccNum && accountNumber === selectedOriginAccNum) {
                            mostrarMensaje("Advertencia", "No puede transferir a su propia cuenta de origen.", true);
                            return;
                        }

                        const account = await buscarCuentaPorNumero(accountNumber);
                        if (account) {
                            foundDestinationAccount = account;
                            nombreTitularDestinoInput.value = account.userName || 'N/A';
                            apellidoTitularDestinoInput.value = account.userLastName || 'N/A';
                            tipoCuentaDestinoInput.value = account.accountType || 'N/A';
                            datosCuentaDestinoDiv.classList.remove('hidden');
                            if (mensaje) mensaje.textContent = '';
                        } else {
                            datosCuentaDestinoDiv.classList.add('hidden');
                        }
                    } else if (accountNumber.length < 6 && foundDestinationAccount) {
                        // Si el usuario borra el n√∫mero, ocultar los datos
                        datosCuentaDestinoDiv.classList.add('hidden');
                        nombreTitularDestinoInput.value = '';
                        apellidoTitularDestinoInput.value = '';
                        tipoCuentaDestinoInput.value = '';
                        foundDestinationAccount = null;
                    }
                }, 500); // 500ms de retardo
            });
        }

        // Manejar el env√≠o del formulario de transferencia a otro usuario
        if (form) {
            form.onsubmit = async e => {
                e.preventDefault();

                const originAccountNumber = cuentaOrigenSelect.value;
                const destinationAccountNumber = numeroCuentaDestinoBusquedaInput.value.trim(); // Usar el valor del input
                const amount = parseFloat(montoTransferenciaOtroUsuarioInput.value);
                const description = descripcionTransferenciaOtroUsuarioInput.value.trim();

                // Validaciones previas al env√≠o
                if (!originAccountNumber) {
                    mostrarMensaje("Error", "Por favor, seleccione su cuenta de origen.", true);
                    return;
                }
                if (!destinationAccountNumber) {
                    mostrarMensaje("Error", "Por favor, ingrese el n√∫mero de cuenta de destino.", true);
                    return;
                }
                if (!foundDestinationAccount || foundDestinationAccount.accountNumber !== destinationAccountNumber) {
                    // Asegurarse de que la cuenta de destino fue buscada y validada
                    mostrarMensaje("Error", "Por favor, busque y valide la cuenta de destino antes de transferir.", true);
                    return;
                }
                if (isNaN(amount) || amount <= 0) {
                    mostrarMensaje("Error", 'Por favor, ingrese un monto v√°lido mayor a cero.', true);
                    return;
                }
                if (originAccountNumber === destinationAccountNumber) {
                    mostrarMensaje('Error', 'No puede transferir a su propia cuenta. Utilice la transferencia interna.', true);
                    return;
                }

                // Validar saldo de la cuenta de origen
                const selectedOriginAccount = userAccounts.find(acc => acc.accountNumber === originAccountNumber);
                if (selectedOriginAccount && amount > selectedOriginAccount.balance) {
                    mostrarMensaje("Error", `Saldo insuficiente en la cuenta de origen. Su saldo actual es: ${formatoMoneda(selectedOriginAccount.balance)}.`, true);
                    return;
                }

                // Confirmaci√≥n antes de transferir (opcional, pero buena pr√°ctica)
                const confirmacion = confirm(`¬øEst√° seguro de que desea transferir ${formatoMoneda(amount)} de su cuenta ${originAccountNumber} a la cuenta ${destinationAccountNumber} (Titular: ${foundDestinationAccount.userName || 'Desconocido'})?`);
                if (!confirmacion) {
                    return; // El usuario cancel√≥
                }

                try {
                    const response = await fetch(`${window.location.origin}/api/transactions/transfer-to-other-user`, { // Tu endpoint de backend
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            originAccountNumber: originAccountNumber,
                            destinationAccountNumber: destinationAccountNumber,
                            amount: amount,
                            description: description
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        mostrarMensaje("Error", data.message || 'Error al realizar la transferencia a otro usuario.', true);
                        return;
                    }

                    let newOriginBalance = null;
                    if (data.movements && data.movements.length > 0) {
                        const originMovement = data.movements.find(mov => mov.accountNumber === originAccountNumber);
                        if (originMovement && originMovement.balance !== undefined) {
                            newOriginBalance = originMovement.balance;
                        }
                    }

                    const balanceMessage = newOriginBalance !== null ? ` Nuevo saldo de origen: ${formatoMoneda(newOriginBalance)}` : '';
                    mostrarMensaje("√âxito", `Transferencia de ${formatoMoneda(amount)} de ${originAccountNumber} a ${destinationAccountNumber} realizada con √©xito.${balanceMessage}`);
                    
                    // Limpiar el formulario y reiniciar el estado
                    form.reset();
                    numeroCuentaDestinoBusquedaInput.value = '';
                    datosCuentaDestinoDiv.classList.add('hidden');
                    nombreTitularDestinoInput.value = '';
                    apellidoTitularDestinoInput.value = '';
                    tipoCuentaDestinoInput.value = '';
                    foundDestinationAccount = null;
                    
                    await cargarCuentasUsuario(); // Recargar cuentas para actualizar saldos en el select
                    populateAccountSelect('cuentaOrigenOtroUsuario'); // Repopular el select de origen
                } catch (error) {
                    console.error('Error al realizar la transferencia a otro usuario:', error);
                    mostrarMensaje("Error", `Error: ${error.message}`, true);
                }
            };
        }
    }

    /**
     * Inicializa la secci√≥n de historial, incluyendo la l√≥gica de filtrado y reporter√≠a.
     * Ahora obtiene los datos del backend.
     */
    function inicializarHistorial() {
        console.log("Inicializando secci√≥n Historial...");
        const fechaInicioInput = document.getElementById('fechaInicio');
        const fechaFinInput = document.getElementById('fechaFin');
        const tipoMovimientoSelect = document.getElementById('tipoMovimiento');
        const btnFiltrar = document.getElementById('btnFiltrar');
        const btnReportesHistorial = document.getElementById('btnReportesHistorial');

        // Funci√≥n para cargar y mostrar movimientos desde el backend
        const cargarMovimientos = () => {
            console.log("Cargando movimientos para el historial completo...");
            const cacheBuster = new Date().getTime(); // Par√°metro √∫nico para evitar cach√©
            let url = `${window.location.origin}/api/movements/history?_=${cacheBuster}`; // URL absoluta
            const params = new URLSearchParams();

            // A√±adir par√°metros de filtro si existen valores en los inputs
            if (fechaInicioInput.value) {
                params.append('startDate', fechaInicioInput.value);
            }
            if (fechaFinInput.value) {
                params.append('endDate', fechaFinInput.value);
            }
            if (tipoMovimientoSelect.value !== 'todos') {
                params.append('type', tipoMovimientoSelect.value.toUpperCase());
            }

            url += params.toString(); // Concatena los par√°metros a la URL
            console.log("URL de fetch para historial (con anti-cach√©):", url);

            fetch(url, { cache: 'no-store' }) // Forzar no cach√©
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            window.location.href = `${window.location.origin}/login`; // URL absoluta
                        }
                        throw new Error('Error al obtener el historial de movimientos. Estado: ' + response.status);
                    }
                    return response.json(); // Parsea la respuesta JSON
                })
                .then(data => {
                    console.log("Datos recibidos para historial completo (con anti-cach√©):", data);
                    pintarTablaMovimientos(data, 'tablaMovimientos'); // Llama a la funci√≥n para pintar la tabla con los datos del backend
                })
                .catch(error => {
                    console.error('Error cargando movimientos:', error);
                    const tabla = document.getElementById('tablaMovimientos');
                    if (tabla) {
                        // Muestra un mensaje de error en la tabla, ajustando el colspan
                        tabla.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-red-400">Error al cargar movimientos.</td></tr>';
                    }
                });
        };

        // Cargar movimientos la primera vez que se inicializa la secci√≥n del historial
        cargarMovimientos();

        // Asignar el evento click al bot√≥n de filtrar para recargar movimientos
        if (btnFiltrar) {
            btnFiltrar.onclick = cargarMovimientos;
        }

        // Evento para el bot√≥n de reportes (funcionalidad no implementada en backend a√∫n)
        if (btnReportesHistorial) {
            btnReportesHistorial.addEventListener('click', () => {
                mostrarMensaje("Informaci√≥n", "Generando reporte de historial (funcionalidad no implementada en backend a√∫n).");
            });
        }
    }

    /**
     * Inicializa la secci√≥n de detalle de servicio para pagos.
     * @param {string} serviceId - El ID del servicio a detallar (ej. 'luz').
     */
    async function inicializarServicioDetalle(serviceId) {
        console.log("Inicializando secci√≥n Detalle de Servicio:", serviceId);
        const formPagoServicio = document.getElementById('formPagoServicio');
        const btnVolverServicios = document.getElementById('btnVolverServicios');
        const mensajePago = document.getElementById('mensajePagoServicio');
        const cuentaOrigenServicioSelect = document.getElementById('cuentaOrigenServicio');
        const servicio = serviciosData[serviceId];

        if (!formPagoServicio) return;

        await cargarCuentasUsuario();
        populateAccountSelect('cuentaOrigenServicio');

        formPagoServicio.onsubmit = async e => {
            e.preventDefault();
            const monto = parseFloat(formPagoServicio.montoPagar.value);
            const descripcion = formPagoServicio.descripcionPago.value.trim();
            const originAccountNumber = cuentaOrigenServicioSelect.value;

            if (isNaN(monto) || monto <= 0 || !originAccountNumber) {
                mensajePago.textContent = 'Por favor, introduce un monto v√°lido y selecciona una cuenta.';
                mensajePago.className = 'text-red-500 mt-4 text-center';
                return;
            }

            // Validar saldo
            const selectedOriginAccount = userAccounts.find(acc => acc.accountNumber === originAccountNumber);
            if (selectedOriginAccount && monto > selectedOriginAccount.balance) {
                mostrarMensaje("Error", `Saldo insuficiente en la cuenta de origen. Su saldo actual es: ${formatoMoneda(selectedOriginAccount.balance)}.`, true);
                return;
            }

            const nuevaDescripcion = descripcion ? `Pago ${servicio.nombre}: ${descripcion}` : `Pago ${servicio.nombre}`;
            
            try {
                const response = await fetch(`${window.location.origin}/api/servicios/pago`, { // URL absoluta
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        accountNumber: originAccountNumber,
                        amount: monto,
                        description: nuevaDescripcion,
                        serviceCode: servicio.codigo
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    mostrarMensaje("Error", data.message || `Error al realizar el pago de ${servicio.nombre}.`, true);
                    return;
                }

                mostrarMensaje("√âxito", `¬°Pago de ${servicio.nombre} por ${formatoMoneda(monto)} realizado con √©xito! Nuevo saldo: ${formatoMoneda(data.balance)}`);
                formPagoServicio.reset(); // Limpiar el formulario
                await cargarCuentasUsuario();
                populateAccountSelect('cuentaOrigenServicio');
            } catch (error) {
                console.error('Error al realizar el pago del servicio:', error);
                mostrarMensaje("Error", `Error: ${error.message}`, true);
            }
        };

        if (btnVolverServicios) {
            btnVolverServicios.addEventListener('click', () => {
                // Al volver a servicios, ocultamos el contenido actual y mostramos el bot√≥n del men√∫.
                contenido.innerHTML = `<p class="text-center mt-20 text-gray-400">Selecciona una opci√≥n de servicios del men√∫ lateral.</p>`;
                btnToggleSidebar.style.display = 'block'; // Asegura que el bot√≥n sea visible
                sidebar.classList.add('-translate-x-full'); // Asegura que el sidebar est√© oculto
                overlay.classList.add('hidden'); // Oculta el overlay
                contenido.classList.remove('con-sidebar-visible'); // Quita el margen del contenido

                // Desactivar el sub-item activo (si lo hubiera)
                document.querySelectorAll(".submenu-item").forEach(l =>
                    l.classList.remove("bg-emerald-600", "text-white")
                );
                // Asegurarse de que la pesta√±a "Servicios" padre se mantenga activa si se regresa de un sub-servicio
                toggleServiciosSidebar.classList.add("bg-emerald-600", "text-white");
            });
        }
    }

    /**
     * Genera din√°micamente los elementos del submen√∫ de servicios.
     */
    function generarSubmenuServicios() {
        submenuServicios.innerHTML = ''; // Limpiar cualquier contenido previo
        for (const key in serviciosData) {
            if (serviciosData.hasOwnProperty(key)) {
                const service = serviciosData[key];
                const link = document.createElement('a');
                link.href = '#';
                link.className = 'submenu-item flex items-center px-4 py-2 rounded-full hover:bg-emerald-600 hover:text-white cursor-pointer transition-transform duration-300 ease-in-out hover:scale-105';
                // Usamos data-service-id para identificar el servicio espec√≠fico
                link.setAttribute('data-service-id', key); 
                link.setAttribute('data-id', 'servicioDetalle'); // Para que mostrarSeccion lo maneje
                link.innerHTML = `${service.icono}<span>${service.nombre}</span>`;
                
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    mostrarSeccion('servicioDetalle', key);
                });
                submenuServicios.appendChild(link);
            }
        }
    }

    // Evento para alternar el submen√∫ de servicios
    toggleServiciosSidebar.addEventListener('click', (e) => {
        e.preventDefault();
        const isHidden = submenuServicios.classList.contains('hidden');
        if (isHidden) {
            submenuServicios.classList.remove('hidden');
            arrowIcon.classList.add('rotate-180');
        } else {
            submenuServicios.classList.add('hidden');
            arrowIcon.classList.remove('rotate-180');
        }

        // Desactivar todos los otros links de la sidebar, pero no los sub-items (a√∫n)
        document.querySelectorAll(".sidebar-link").forEach(l => {
            if (l.id !== 'toggleServiciosSidebar' && l.id !== 'toggleTransaccionesSidebar') { // Excluir el toggle de transacciones tambi√©n
                l.classList.remove("bg-emerald-600", "text-white");
            }
        });
        // Desactivar los sub-items (si alguno estaba activo)
        document.querySelectorAll(".submenu-item").forEach(l =>
            l.classList.remove("bg-emerald-600", "text-white")
        );
        // Activar siempre la pesta√±a "Servicios" al hacerle clic
        e.currentTarget.classList.add("bg-emerald-600", "text-white");

        // Ocultar el submen√∫ de transacciones si est√° abierto
        submenuTransacciones.classList.add('hidden');
        arrowIconTransacciones.classList.remove('rotate-180');

        // Ocultar el bot√≥n del men√∫ cuando el sidebar de servicios se abre (est√° visible)
        btnToggleSidebar.style.display = 'none';
        overlay.classList.remove('hidden'); // Mostrar overlay
    });

    // Evento para alternar el submen√∫ de Transacciones
    toggleTransaccionesSidebar.addEventListener('click', (e) => {
        e.preventDefault();
        const isHidden = submenuTransacciones.classList.contains('hidden');
        if (isHidden) {
            submenuTransacciones.classList.remove('hidden');
            arrowIconTransacciones.classList.add('rotate-180');
        } else {
            submenuTransacciones.classList.add('hidden');
            arrowIconTransacciones.classList.remove('rotate-180');
        }

        // Desactivar todos los otros links de la sidebar
        document.querySelectorAll(".sidebar-link").forEach(l => {
            if (l.id !== 'toggleTransaccionesSidebar' && l.id !== 'toggleServiciosSidebar') {
                l.classList.remove("bg-emerald-600", "text-white");
            }
        });
        // Desactivar los sub-items de servicios si alguno estaba activo
        document.querySelectorAll(".submenu-item").forEach(l =>
            l.classList.remove("bg-emerald-600", "text-white")
        );
        // Activar siempre la pesta√±a "Transacciones" al hacerle clic
        e.currentTarget.classList.add("bg-emerald-600", "text-white");

        // Ocultar el submen√∫ de servicios si est√° abierto
        submenuServicios.classList.add('hidden');
        arrowIcon.classList.remove('rotate-180');

        // Ocultar el bot√≥n del men√∫ cuando el sidebar de transacciones se abre
        btnToggleSidebar.style.display = 'none';
        overlay.classList.remove('hidden'); // Mostrar overlay
    });


    // Evento para alternar la barra lateral principal
    btnToggleSidebar.addEventListener('click', () => {
        const sidebarVisible = !sidebar.classList.contains('-translate-x-full');
        if (sidebarVisible) {
            // Si el sidebar est√° visible, lo ocultamos y mostramos el bot√≥n
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden'); // Ocultar overlay
            contenido.classList.remove('con-sidebar-visible');
            btnToggleSidebar.style.display = 'block'; 
        } else {
            // Si el sidebar est√° oculto, lo mostramos y ocultamos el bot√≥n
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden'); // Mostrar overlay
            contenido.classList.add('con-sidebar-visible');
            btnToggleSidebar.style.display = 'none';
        }
    });

    // Evento para cerrar el sidebar al hacer clic en el overlay
    overlay.addEventListener('click', () => {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
        contenido.classList.remove('con-sidebar-visible');
        btnToggleSidebar.style.display = 'block';
    });


    // Cambiar secci√≥n al hacer clic en enlaces de la sidebar (excluyendo los toggles)
    document.querySelectorAll('.sidebar-link').forEach(link => {
        if (link.id !== 'toggleServiciosSidebar' && link.id !== 'toggleTransaccionesSidebar') {
            link.addEventListener('click', e => {
                e.preventDefault();
                const id = link.getAttribute('data-id');
                mostrarSeccion(id);
            });
        }
    });

    // Cambiar secci√≥n al hacer clic en enlaces del submen√∫ de Transacciones
    document.querySelectorAll('#submenuTransacciones .submenu-item').forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            const id = link.getAttribute('data-id');
            mostrarSeccion(id);
        });
    });

    // L√≥gica para el estado inicial y al redimensionar la ventana
    function adjustInitialLayout() {
        // En desktop, el sidebar siempre est√° visible y el bot√≥n oculto
        if (window.innerWidth >= 1024) { 
            sidebar.classList.remove('-translate-x-full');
            contenido.classList.add('con-sidebar-visible');
            btnToggleSidebar.style.display = 'none'; // Ocultar el bot√≥n en desktop
            overlay.classList.add('hidden'); // Asegurarse de que el overlay est√© oculto en desktop
        } else {
            // En m√≥vil, el sidebar inicia oculto y el bot√≥n visible
            sidebar.classList.add('-translate-x-full');
            contenido.classList.remove('con-sidebar-visible');
            btnToggleSidebar.style.display = 'block'; // Mostrar el bot√≥n en m√≥vil
            overlay.classList.add('hidden'); // Asegurarse de que el overlay est√© oculto inicialmente en m√≥vil
        }
    }

    // Inicializar la vista al cargar la p√°gina
    generarSubmenuServicios();
    mostrarSeccion('inicio'); // Carga la secci√≥n de inicio por defecto
    document.querySelector('.sidebar-link[data-id="inicio"]').classList.add("bg-emerald-600", "text-white");
    
    // Ajustar el layout al cargar la p√°gina y al redimensionar
    adjustInitialLayout();
    window.addEventListener('resize', adjustInitialLayout);

</script>

</body>
</html>
