<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyprBank - Cambiar Contraseña</title>
    <!-- Enlace a tu archivo local de Tailwind CSS -->
    <link rel="stylesheet" href="/css/output.css">
    <!-- CDN de SweetAlert2 para los mensajes de alerta -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen flex items-center justify-center">

    <div class="container mx-auto px-4">
        <div class="max-w-md mx-auto bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700/30">
            <h2 class="text-3xl font-bold text-center text-emerald-400 mb-6">Cambiar Contraseña</h2>
            <p class="text-gray-300 text-center mb-6">Por favor, establece una nueva contraseña para tu cuenta.</p>

            <form id="changePasswordForm" class="space-y-6">
                <div>
                    <label for="newPassword" class="block text-gray-300 text-sm font-bold mb-2">Nueva Contraseña:</label>
                    <input
                        type="password"
                        id="newPassword"
                        name="newPassword"
                        class="shadow appearance-none border rounded-lg w-full py-3 px-4 bg-gray-700 text-white leading-tight focus:outline-none focus:shadow-outline focus:border-emerald-500"
                        placeholder="Ingresa tu nueva contraseña"
                        required
                    >
                    <div id="passwordPolicyIndicators" class="mt-2 text-sm text-gray-400 space-y-1">
                        <p class="flex items-center">
                            <span id="len-indicator" class="w-3 h-3 rounded-full bg-red-400 mr-2 flex-shrink-0"></span>
                            <span id="len-text">Mínimo 8 caracteres</span>
                        </p>
                        <p class="flex items-center">
                            <span id="upper-indicator" class="w-3 h-3 rounded-full bg-red-400 mr-2 flex-shrink-0"></span>
                            <span id="upper-text">Al menos 1 mayúscula</span>
                        </p>
                        <p class="flex items-center">
                            <span id="lower-indicator" class="w-3 h-3 rounded-full bg-red-400 mr-2 flex-shrink-0"></span>
                            <span id="lower-text">Al menos 1 minúscula</span>
                        </p>
                        <p class="flex items-center">
                            <span id="num-indicator" class="w-3 h-3 rounded-full bg-red-400 mr-2 flex-shrink-0"></span>
                            <span id="num-text">Al menos 1 número</span>
                        </p>
                        <p class="flex items-center">
                            <span id="special-indicator" class="w-3 h-3 rounded-full bg-red-400 mr-2 flex-shrink-0"></span>
                            <span id="special-text">Al menos 1 caracter especial</span>
                        </p>
                    </div>
                </div>
                <div>
                    <label for="confirmPassword" class="block text-gray-300 text-sm font-bold mb-2">Confirmar Contraseña:</label>
                    <input
                        type="password"
                        id="confirmPassword"
                        name="confirmPassword"
                        class="shadow appearance-none border rounded-lg w-full py-3 px-4 bg-gray-700 text-white leading-tight focus:outline-none focus:shadow-outline focus:border-emerald-500"
                        placeholder="Confirma tu nueva contraseña"
                        required
                    >
                    <p id="matchWarning" class="text-red-400 text-xs mt-2 hidden">Las contraseñas no coinciden.</p>
                </div>
                <div class="flex items-center justify-center">
                    <button
                        type="submit"
                        class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-full focus:outline-none focus:shadow-outline transition duration-200 ease-in-out transform hover:scale-105"
                    >
                        Cambiar Contraseña
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Función para mostrar SweetAlert2
        function showSweetAlert(icon, title, text, callback = null) {
            Swal.fire({
                icon: icon,
                title: title,
                text: text,
                background: '#2D3748', // bg-gray-800
                color: '#CBD5E0', // text-gray-300
                confirmButtonColor: '#10B981', // bg-emerald-600
                willClose: callback // Ejecutar callback al cerrar la alerta
            });
        }

        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const passwordPolicyIndicators = {
            len: document.getElementById('len-indicator'),
            upper: document.getElementById('upper-indicator'),
            lower: document.getElementById('lower-indicator'),
            num: document.getElementById('num-indicator'),
            special: document.getElementById('special-indicator')
        };
        const matchWarning = document.getElementById('matchWarning');
        const changePasswordForm = document.getElementById('changePasswordForm');

        function updateIndicator(indicatorElement, isValid) {
            if (isValid) {
                indicatorElement.classList.remove('bg-red-400');
                indicatorElement.classList.add('bg-green-400');
            } else {
                indicatorElement.classList.remove('bg-green-400');
                indicatorElement.classList.add('bg-red-400');
            }
        }

        function validatePasswordPolicy(password) {
            let isValid = true;

            // Mínimo 8 caracteres
            const isLenValid = password.length >= 8;
            updateIndicator(passwordPolicyIndicators.len, isLenValid);
            if (!isLenValid) isValid = false;

            // Mínimo una mayúscula
            const isUpperValid = /[A-Z]/.test(password);
            updateIndicator(passwordPolicyIndicators.upper, isUpperValid);
            if (!isUpperValid) isValid = false;

            // Mínimo una minúscula
            const isLowerValid = /[a-z]/.test(password);
            updateIndicator(passwordPolicyIndicators.lower, isLowerValid);
            if (!isLowerValid) isValid = false;

            // Mínimo un número
            const isNumValid = /\d/.test(password);
            updateIndicator(passwordPolicyIndicators.num, isNumValid);
            if (!isNumValid) isValid = false;

            // Mínimo un carácter especial
            // Se corrigió la expresión regular para escapar correctamente todos los caracteres especiales dentro de la clase.
            const isSpecialValid = /[!@#$%^&*()\-_=+\\[\]\\{\\}\\|;:'",<.>/?]/.test(password);
            updateIndicator(passwordPolicyIndicators.special, isSpecialValid);
            if (!isSpecialValid) isValid = false;

            return isValid;
        }

        function validatePasswordsMatch() {
            const newPass = newPasswordInput.value;
            const confirmPass = confirmPasswordInput.value;
            if (newPass === confirmPass && newPass !== '') {
                matchWarning.classList.add('hidden');
                return true;
            } else {
                matchWarning.classList.remove('hidden');
                return false;
            }
        }

        newPasswordInput.addEventListener('input', () => {
            validatePasswordPolicy(newPasswordInput.value);
            validatePasswordsMatch();
        });

        confirmPasswordInput.addEventListener('input', validatePasswordsMatch);

        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (!validatePasswordPolicy(newPassword)) {
                showSweetAlert('error', 'Error de Contraseña', 'La nueva contraseña no cumple con la política de seguridad.');
                return;
            }

            if (!validatePasswordsMatch()) {
                showSweetAlert('error', 'Error de Contraseña', 'Las contraseñas no coinciden.');
                return;
            }

            try {
                const response = await fetch(`${window.location.origin}/api/password/change`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newPassword: newPassword })
                });

                const data = await response.json();

                if (response.ok) {
                    showSweetAlert('success', 'Éxito', data.message || 'Contraseña cambiada exitosamente. Serás redirigido al dashboard.', () => {
                        window.location.href = `${window.location.origin}/dashboard/user`; // Redirigir al dashboard del usuario
                    });
                } else {
                    showSweetAlert('error', 'Error', data.message || 'Error al cambiar la contraseña. Inténtalo de nuevo.', true);
                }
            } catch (error) {
                console.error('Error:', error);
                showSweetAlert('error', 'Error de Conexión', 'No se pudo conectar con el servidor para cambiar la contraseña.', true);
            }
        });

        // Inicializar los indicadores al cargar la página si ya hay texto en el campo (ej. autocompletado)
        validatePasswordPolicy(newPasswordInput.value);
    </script>
</body>
</html>