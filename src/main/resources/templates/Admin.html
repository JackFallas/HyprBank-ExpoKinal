<!DOCTYPE html>
<html lang="es" class="dark" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
  <head>
    <meta charset="UTF-8" />
    <title>Administrador | HyprBank</title>
    <!-- Enlace a tu archivo local de Tailwind CSS -->
    <link rel="stylesheet" href="/css/output.css">
    <!-- Chart.js para gr√°ficas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- CDN de SweetAlert2 para los mensajes de alerta -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body class="bg-gray-900 text-white font-sans">
    <!-- *** L√çNEA DE DEPURACI√ìN CR√çTICA: SI ESTO NO APARECE, HAY UN PROBLEMA DE PARSEO HTML/THYMELEAF *** -->
    <script>
      console.log("¬°El body se est√° cargando y este script INICIAL se ejecut√≥!");
    </script>
    <!----------------------------------------------------------------------------------------------------->

    <div class="flex min-h-screen">
      <button
        id="btnToggleSidebar"
        aria-label="Mostrar men√∫ lateral"
        class="fixed top-4 left-4 z-50 bg-emerald-600 p-3 rounded-md shadow-md hover:bg-emerald-700 transition focus:outline-none focus:ring-2 focus:ring-emerald-400"
      >
        ‚ò∞
      </button>
      <div
        id="overlay"
        class="fixed inset-0 bg-black bg-opacity-50 opacity-0 pointer-events-none transition-opacity duration-300 z-40"
      ></div>

      <!-- Barra lateral -->
      <aside
        id="sidebar"
        class="fixed top-0 left-0 z-50 w-64 h-screen bg-gray-800 flex flex-col p-6 space-y-6 transform -translate-x-full transition-transform duration-300 ease-in-out"
      >
        <div>
          <div
            class="flex items-center space-x-3 text-2xl font-bold text-white mb-6 select-none"
          >
            <span>üõ†Ô∏è</span><span>Admin HyprBank</span>
          </div>
          <nav class="flex flex-col space-y-3">
            <a
              href="#"
              data-id="inicio"
              class="sidebar-link flex items-center px-4 py-3 rounded-full text-gray-300 hover:bg-emerald-600 hover:text-white cursor-pointer transition-transform duration-300 ease-in-out hover:scale-105"
              >Inicio</a
            >
            <a
              href="#"
              data-id="clientes"
              class="sidebar-link flex items-center px-4 py-3 rounded-full text-gray-300 hover:bg-emerald-600 hover:text-white cursor-pointer transition-transform duration-300 ease-in-out hover:scale-105"
              >Clientes</a
            >
            <a
              href="#"
              data-id="deposito"
              class="sidebar-link flex items-center px-4 py-3 rounded-full text-gray-300 hover:bg-emerald-600 hover:text-white cursor-pointer transition-transform duration-300 ease-in-out hover:scale-105"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                Dep√≥sito
            </a>
            <a
              href="#"
              data-id="todosMovimientos"
              class="sidebar-link flex items-center px-4 py-3 rounded-full text-gray-300 hover:bg-emerald-600 hover:text-white cursor-pointer transition-transform duration-300 ease-in-out hover:scale-105"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
                Todos los Movimientos
            </a>
            <a
              href="#"
              data-id="reportes"
              class="sidebar-link flex items-center px-4 py-3 rounded-full text-gray-300 hover:bg-emerald-600 hover:text-white cursor-pointer transition-transform duration-300 ease-in-out hover:scale-105"
              >Reportes</a
            >
            <div class="mt-auto">
                <a href="/logout" data-id="cerrarSesion" class="flex items-center px-4 py-3 rounded-full text-gray-300 hover:bg-red-600 hover:text-white cursor-pointer transition-transform duration-300 ease-in-out hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7" />
                    </svg>
                    Cerrar sesi√≥n
                </a>
            </div>
          </nav>
        </div>
      </aside>

<!-- Modal para registrar nuevo cliente -->
<div id="modalRegistrarCliente" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-gray-900 rounded-xl shadow-xl w-full max-w-md p-6">
        <h2 class="text-2xl font-bold mb-4 text-emerald-400">‚ûï Registrar Nuevo Cliente</h2>
        <form id="formRegistrarCliente" class="space-y-4">
            <div>
                <label class="block mb-1 text-sm" for="regFirstName">Nombre:</label>
                <input type="text" id="regFirstName" name="firstName" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" required placeholder="Ingrese el nombre del cliente" />
            </div>
            <div>
                <label class="block mb-1 text-sm" for="regLastName">Apellido:</label>
                <input type="text" id="regLastName" name="lastName" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" required placeholder="Ingrese el apellido del cliente" />
            </div>
            <div>
                <label class="block mb-1 text-sm" for="regEmail">Email:</label>
                <input type="email" id="regEmail" name="email" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" required placeholder="Ingrese el email del cliente" />
                <p id="emailWarning" class="text-red-400 text-xs mt-1 hidden">Ingrese un email v√°lido.</p>
            </div>
            <div>
                <label class="block mb-1 text-sm" for="regDPI">DPI:</label>
                <input type="text" id="regDPI" name="dpi" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" placeholder="Ingrese el DPI del cliente (13 d√≠gitos)" maxlength="13" />
                <p id="dpiWarning" class="text-red-400 text-xs mt-1 hidden">El DPI debe contener 13 d√≠gitos num√©ricos.</p>
            </div>
            <div>
                <label class="block mb-1 text-sm" for="regNIT">NIT:</label>
                <input type="text" id="regNIT" name="nit" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" placeholder="Ingrese el NIT del cliente (Ej. 1234567-8 o CF)" />
                <p id="nitWarning" class="text-red-400 text-xs mt-1 hidden">Ingrese un NIT v√°lido (ej. 1234567-8 o CF).</p>
            </div>
            <div>
                <label class="block mb-1 text-sm" for="regPhoneNumber">N√∫mero de Tel√©fono:</label>
                <input type="text" id="regPhoneNumber" name="phoneNumber" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" placeholder="Ej. 1234-5678" maxlength="9" />
                <p id="phoneWarning" class="text-red-400 text-xs mt-1 hidden">Ingrese un n√∫mero de tel√©fono v√°lido (8 d√≠gitos, formato 1234-5678).</p>
            </div>
            <div>
                <label class="block mb-1 text-sm" for="regBirthDate">Fecha de Nacimiento:</label>
                <input type="date" id="regBirthDate" name="birthDate" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" required />
                <p id="birthDateWarning" class="text-red-400 text-xs mt-1 hidden">Debe ser mayor de 18 a√±os.</p>
            </div>
            <div>
                <label class="block mb-1 text-sm" for="regAddress">Direcci√≥n:</label>
                <input type="text" id="regAddress" name="address" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" required placeholder="Ingrese la direcci√≥n del cliente" />
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" id="btnCancelarRegistro" class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-emerald-600 rounded hover:bg-emerald-700">Registrar</button>
            </div>
        </form>
    </div>
</div>


<!-- Modal para editar cliente -->
<div id="modalEditarCliente" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
  <div class="bg-gray-900 rounded-xl shadow-xl w-full max-w-md p-6">
    <h2 class="text-2xl font-bold mb-4 text-emerald-400">‚úèÔ∏è Editar Cliente</h2>
    <form id="formEditarCliente" class="space-y-4">
      <input type="hidden" id="editarIdCliente" /> <!-- Campo oculto para el ID del cliente -->
      <div>
        <label class="block mb-1 text-sm" for="editarNombre">Nombre</label>
        <input type="text" id="editarNombre" name="firstName" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" required />
      </div>
      <div>
        <label class="block mb-1 text-sm" for="editarApellido">Apellido</label>
        <input type="text" id="editarApellido" name="lastName" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" required />
      </div>
      <div>
        <label class="block mb-1 text-sm" for="editarEmail">Email</label>
        <input type="email" id="editarEmail" name="email" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" required />
        <p id="editarEmailWarning" class="text-red-400 text-xs mt-1 hidden">Ingrese un email v√°lido.</p>
      </div>
      <div>
        <label class="block mb-1 text-sm" for="editarDPI">DPI</label>
        <input type="text" id="editarDPI" name="dpi" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" maxlength="13"/>
        <p id="editarDpiWarning" class="text-red-400 text-xs mt-1 hidden">El DPI debe contener 13 d√≠gitos num√©ricos.</p>
      </div>
      <div>
        <label class="block mb-1 text-sm" for="editarNIT">NIT</label>
        <input type="text" id="editarNIT" name="nit" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" />
        <p id="editarNitWarning" class="text-red-400 text-xs mt-1 hidden">Ingrese un NIT v√°lido (ej. 1234567-8 o CF).</p>
      </div>
      <div>
        <label class="block mb-1 text-sm" for="editarTelefono">Tel√©fono</label>
        <input type="text" id="editarTelefono" name="phoneNumber" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" maxlength="9" />
        <p id="editarPhoneWarning" class="text-red-400 text-xs mt-1 hidden">Ingrese un n√∫mero de tel√©fono v√°lido (8 d√≠gitos, formato 1234-5678).</p>
      </div>
      <div>
        <label class="block mb-1 text-sm" for="editarAddress">Direcci√≥n:</label>
        <input type="text" id="editarAddress" name="address" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" required placeholder="Ingrese la direcci√≥n del cliente" />
      </div>
      <div>
        <label class="block mb-1 text-sm" for="editarBirthDate">Fecha de Nacimiento:</label>
        <input type="date" id="editarBirthDate" name="birthDate" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" required />
        <p id="editarBirthDateWarning" class="text-red-400 text-xs mt-1 hidden">Debe ser mayor de 18 a√±os.</p>
      </div>
      <div>
        <label class="block mb-1 text-sm" for="editarEstado">Estado</label>
        <select id="editarEstado" name="status" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600">
          <option value="ACTIVO">Activo</option>
          <option value="INACTIVO">Inactivo</option>
          <option value="BLOQUEADO">Bloqueado</option>
        </select>
      </div>
      <!-- Campos de contrase√±a para edici√≥n (opcional) -->
      <div>
        <label class="block mb-1 text-sm" for="editarNewPassword">Nueva Contrase√±a (opcional):</label>
        <input type="password" id="editarNewPassword" name="newPassword" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" placeholder="Dejar en blanco para no cambiar" />
        <div id="editPasswordPolicyIndicators" class="mt-2 text-sm text-gray-400 space-y-1">
            <p class="flex items-center">
                <span id="edit-len-indicator" class="w-3 h-3 rounded-full bg-red-400 mr-2 flex-shrink-0"></span>
                <span id="edit-len-text">M√≠nimo 8 caracteres</span>
            </p>
            <p class="flex items-center">
                <span id="edit-upper-indicator" class="w-3 h-3 rounded-full bg-red-400 mr-2 flex-shrink-0"></span>
                <span id="edit-upper-text">Al menos 1 may√∫scula</span>
            </p>
            <p class="flex items-center">
                <span id="edit-lower-indicator" class="w-3 h-3 rounded-full bg-red-400 mr-2 flex-shrink-0"></span>
                <span id="edit-lower-text">Al menos 1 min√∫scula</span>
            </p>
            <p class="flex items-center">
                <span id="edit-num-indicator" class="w-3 h-3 rounded-full bg-red-400 mr-2 flex-shrink-0"></span>
                <span id="edit-num-text">Al menos 1 n√∫mero</span>
            </p>
            <p class="flex items-center">
                <span id="edit-special-indicator" class="w-3 h-3 rounded-full bg-red-400 mr-2 flex-shrink-0"></span>
                <span id="edit-special-text">Al menos 1 caracter especial</span>
            </p>
        </div>
      </div>
      <div>
        <label class="block mb-1 text-sm" for="editarConfirmNewPassword">Confirmar Nueva Contrase√±a:</label>
        <input type="password" id="editarConfirmNewPassword" name="confirmNewPassword" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600" placeholder="Confirma la nueva contrase√±a" />
        <p id="editMatchWarning" class="text-red-400 text-xs mt-1 hidden">Las contrase√±as no coinciden.</p>
      </div>
      <div class="flex justify-end space-x-3 pt-4">
        <button type="button" id="btnCancelarEditar" class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600">Cancelar</button>
        <button type="submit" class="px-4 py-2 bg-emerald-600 rounded hover:bg-emerald-700">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de Confirmaci√≥n para Eliminar -->
<div id="modalConfirmacion" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
  <div class="bg-gray-900 rounded-xl shadow-xl w-full max-w-sm p-6 text-center">
    <h2 class="text-2xl font-bold mb-4 text-red-400">‚ö†Ô∏è Confirmar Eliminaci√≥n</h2>
    <p class="mb-6 text-gray-300">¬øEst√°s seguro de que deseas eliminar este usuario?</p>
    <div class="flex justify-center space-x-4">
      <button type="button" id="btnConfirmarCancelar" class="px-5 py-2 bg-gray-700 rounded-full hover:bg-gray-600">Cancelar</button>
      <button type="button" id="btnConfirmarEliminar" class="px-5 py-2 bg-red-600 rounded-full hover:bg-red-700">Eliminar</button>
    </div>
  </div>
</div>

<!-- Nuevo Modal para mostrar credenciales de usuario creado -->
<div id="modalCredenciales" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-gray-900 rounded-xl shadow-xl w-full max-w-sm p-6 text-center">
        <h2 class="text-2xl font-bold mb-4 text-emerald-400">‚úÖ Usuario Creado con √âxito</h2>
        <p class="mb-2 text-gray-300">Aqu√≠ est√°n los datos de acceso para el nuevo usuario:</p>
        <div class="bg-gray-800 p-4 rounded-md mb-6 text-left">
            <p class="text-gray-200"><strong>Email:</strong> <span id="crearUsuarioEmail"></span></p>
            <p class="text-gray-200"><strong>Contrase√±a:</strong> <span id="crearUsuarioPassword"></span></p>
        </div>
        <button type="button" id="btnCerrarCredenciales" class="px-5 py-2 bg-emerald-600 rounded-full hover:bg-emerald-700">Cerrar</button>
    </div>
</div>


      <!-- Contenedor principal para contenido din√°mico -->
      <main
        id="contenido"
        class="flex-1 p-8 bg-gray-900 overflow-auto min-h-screen"
      ></main>
    </div>

    <script th:inline="javascript">
      // *** VERIFICACI√ìN DE SCRIPT: SI VES ESTO EN LA CONSOLA, EL JS SE EST√Å EJECUTANDO ***
      console.log("Admin.html script principal est√° ejecut√°ndose.");
      console.log("window.location.origin:", window.location.origin); // Log para verificar la URL base

      // Aseg√∫rate de que los datos de los usuarios est√©n disponibles en el JavaScript
      // Esto es crucial para que la tabla se pueda poblar.
      let serverUsers = /*[[${users != null ? users : '[]'}]]*/ [];
      console.log("Usuarios del servidor:", serverUsers); // Depuraci√≥n: ver qu√© datos llegan

      const sidebarLinks = document.querySelectorAll(".sidebar-link");
      
      const contenido = document.getElementById("contenido");

      // Datos ficticios para mostrar (puedes reemplazar con API real)
      // Estos datos se actualizar√°n con llamadas a la API real en las funciones de inicializaci√≥n
      let dashboardStats = {
          totalUsers: 0,
          activeUsers: 0,
          inactiveUsers: 0,
          blockedUsers: 0,
          citasSinConfirmar: 0, // Este dato no se est√° obteniendo del backend actualmente
          nuevosClientesSemana: [0, 0, 0, 0, 0, 0, 0],
          volumenTransaccionesMes: [0, 0, 0, 0, 0, 0],
      };

      // Variable para almacenar todas las cuentas del sistema (para el admin)
      let allSystemAccounts = [];

      // Funci√≥n para formatear n√∫meros a moneda
      function formatoMoneda(num) {
        return num.toLocaleString("es-GT", {
          style: "currency",
          currency: "GTQ",
          minimumFractionDigits: 2,
        });
      }

      // Funci√≥n para capitalizar la primera letra (√∫til para tipos de movimiento)
      function capitalizeFirstLetter(string) {
          if (!string) return '';
          return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
      }

      // Funci√≥n para crear gr√°fico (Chart.js)
      let clientsChartInstance = null; // Instancia global para el gr√°fico de clientes

      function crearGrafico(ctx, labels, data, label, color) {
        // Destruir instancia anterior si existe para evitar duplicados
        if (clientsChartInstance) {
            clientsChartInstance.destroy();
        }
        clientsChartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label,
                data,
                borderColor: color,
                backgroundColor: color + "44",
                fill: true,
                tension: 0.3,
                pointRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                    color: '#CBD5E0' // Color de las etiquetas del eje Y
                }
              },
              x: {
                ticks: {
                    color: '#CBD5E0' // Color de las etiquetas del eje X
                }
              }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#CBD5E0' // Color del texto de la leyenda
                    }
                },
                title: {
                    display: true,
                    text: label, // Usar el label del dataset como t√≠tulo
                    color: '#CBD5E0' // Color del t√≠tulo
                }
            }
          },
        });
        return clientsChartInstance; // Retornar la instancia
      }

      // Contenido din√°mico para cada pesta√±a
      const secciones = {
        inicio: (stats) => `
        <section id="dashboard" class="max-w-6xl mx-auto min-h-[70vh] p-6 text-white">
          <h1 class="text-4xl font-bold mb-8 text-emerald-400 text-center">Dashboard</h1>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center">
              <h2 class="text-xl font-semibold mb-2">Clientes Registrados</h2>
              <p class="text-5xl font-mono text-emerald-400">${stats.totalUsers}</p>
              <button
                data-id="clientes"
                class="mt-3 bg-emerald-600 px-4 py-2 rounded-full hover:bg-emerald-700 transition sidebar-link"
              >Ver m√°s</button>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center">
              <h2 class="text-xl font-semibold mb-2">Clientes Activos / Inactivos</h2>
              <p class="text-3xl font-mono text-emerald-400">${stats.activeUsers} / ${stats.inactiveUsers}</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center">
              <h2 class="text-xl font-semibold mb-2">Clientes Bloqueados</h2>
              <p class="text-3xl font-mono text-yellow-400">${stats.blockedUsers}</p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
              <h3 class="text-xl font-semibold mb-4 text-emerald-400">Distribuci√≥n de Clientes por Estado</h3>
              <canvas id="clientsChart"></canvas>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
              <h3 class="text-xl font-semibold mb-4 text-emerald-400">Volumen de Transacciones por Mes (GTQ)</h3>
              <canvas id="graficoTransacciones"></canvas>
            </div>
          </div>

          <div class="bg-gray-800 p-6 rounded-xl shadow-lg max-w-xl mx-auto text-center">
            <h3 class="text-xl font-semibold mb-4 text-yellow-400">Indicadores de alerta</h3>
            <p>Cuentas bloqueadas: <strong>${stats.blockedUsers}</strong></p>
            <p>Citas sin confirmar: <strong>${stats.citasSinConfirmar}</strong></p>
            <!-- Bot√≥n para generar reporte de accesos de usuarios -->
            <button id="btnReporteAccesos" class="mt-4 bg-purple-600 px-6 py-3 rounded-full font-semibold shadow-lg hover:bg-purple-700 transition">
                Generar Reporte de Accesos (PDF)
            </button>
          </div>
        </section>
        `,

        clientes: `
        <section class="max-w-6xl mx-auto min-h-[70vh] p-6 text-white">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-emerald-400">Clientes</h1>
            <div class="flex space-x-3">
                <button
                  id="btnAbrirModalRegistro"
                  class="bg-emerald-600 px-4 py-2 rounded-full hover:bg-emerald-700 transition"
                >Agregar Cliente</button>
                <!-- Bot√≥n para generar reporte de clientes -->
                <button id="btnReporteClientes" class="bg-blue-600 px-4 py-2 rounded-full hover:bg-blue-700 transition">
                    Generar Reporte de Clientes (PDF)
                </button>
            </div>
          </div>
          <input
            type="text"
            id="buscadorClientes"
            placeholder="Buscar por nombre, email o ID..."
            class="w-full mb-4 px-4 py-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-emerald-500"
          />
          <table class="w-full bg-gray-800 rounded-lg overflow-hidden shadow-lg">
            <thead class="bg-gray-700 text-gray-300">
              <tr>
                <th class="py-3 px-4 text-left">ID</th>
                <th class="py-3 px-4 text-left">Nombre</th>
                <th class="py-3 px-4 text-left">Apellido</th>
                <th class="py-3 px-4 text-left">Email</th>
                <th class="py-3 px-4 text-left">DPI</th>
                <th class="py-3 px-4 text-left">NIT</th>
                <th class="py-3 px-4 text-left">Tel√©fono</th>
                <th class="py-3 px-4 text-left">Estado</th>
                <th class="py-3 px-4 text-left">Acciones</th>
              </tr>
            </thead>
            <tbody id="tablaClientes" class="text-gray-100">
              <!-- Aqu√≠ se cargan los clientes din√°micamente -->
            </tbody>
          </table>
        </section>
        `,
        deposito: `
            <section class="max-w-xl mx-auto min-h-[70vh] p-6 text-white">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-emerald-400 mb-4 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-400 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        Realizar Dep√≥sito
                    </h2>
                    <p class="text-lg text-gray-300 mb-6 text-center">Realiza un dep√≥sito a cualquier cuenta del sistema.</p>

                    <form id="formDepositoAdmin" class="space-y-4">
                        <div class="flex items-end space-x-2">
                            <div class="flex-grow">
                                <label for="numeroCuentaBusqueda" class="block font-semibold mb-1">N√∫mero de Cuenta:</label>
                                <input type="text" id="numeroCuentaBusqueda" name="numeroCuentaBusqueda" placeholder="Ej. 1000000001" class="w-full p-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" required />
                            </div>
                            <button type="button" id="btnBuscarCuenta" class="bg-blue-600 hover:bg-blue-700 p-3 rounded-md font-bold shadow-lg transition focus:outline-none focus:ring-2 focus:ring-blue-400 h-full">
                                Buscar
                            </button>
                        </div>

                        <div id="datosCuenta" class="space-y-3 bg-gray-700 p-4 rounded-md hidden">
                            <h3 class="text-xl font-semibold text-emerald-300">Detalles de la Cuenta:</h3>
                            <div>
                                <label class="block mb-1 text-sm text-gray-300">Nombre del Titular:</label>
                                <input type="text" id="nombreTitular" class="w-full p-2 rounded bg-gray-600 text-white cursor-not-allowed" readonly />
                            </div>
                            <div>
                                <label class="block mb-1 text-sm text-gray-300">Apellido del Titular:</label>
                                <input type="text" id="apellidoTitular" class="w-full p-2 rounded bg-gray-600 text-white cursor-not-allowed" readonly />
                            </div>
                            <div>
                                <label class="block mb-1 text-sm text-gray-300">Tipo de Cuenta:</label>
                                <input type="text" id="tipoCuenta" class="w-full p-2 rounded bg-gray-600 text-white cursor-not-allowed" readonly />
                            </div>
                            <div>
                                <label class="block mb-1 text-sm text-gray-300">Saldo Actual:</label>
                                <input type="text" id="saldoActual" class="w-full p-2 rounded bg-gray-600 text-white cursor-not-allowed" readonly />
                            </div>
                        </div>

                        <div id="camposDeposito" class="space-y-4 hidden">
                            <div>
                                <label for="montoDepositoAdmin" class="block font-semibold mb-1">Monto a depositar (GTQ):</label>
                                <input type="number" id="montoDepositoAdmin" name="montoDepositoAdmin" min="0.01" step="0.01" placeholder="Ej. 500.00" class="w-full p-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" required />
                            </div>
                            <div>
                                <label for="descripcionDepositoAdmin" class="block font-semibold mb-1">Descripci√≥n (opcional):</label>
                                <input type="text" id="descripcionDepositoAdmin" name="descripcionDepositoAdmin" placeholder="Ej. Dep√≥sito en ventanilla" class="w-full p-3 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" />
                            </div>
                            <button type="submit" id="btnConfirmarDeposito" class="w-full mt-4 bg-emerald-600 hover:bg-emerald-700 p-3 rounded-full font-bold shadow-lg transition focus:outline-none focus:ring-2 focus:ring-emerald-400">
                                Confirmar Dep√≥sito
                            </button>
                        </div>
                        <p id="mensajeDepositoAdmin" class="mt-4 text-center"></p>
                    </form>
                </div>
            </section>
        `,
        todosMovimientos: `
            <section class="max-w-7xl mx-auto min-h-[70vh] p-6 text-white">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-emerald-400">Todos los Movimientos del Banco</h1>
                    <!-- Bot√≥n para generar reporte de movimientos (PDF) - Alineado a la derecha -->
                    <button id="btnReporteMovimientos" class="bg-blue-600 px-4 py-2 rounded-full hover:bg-blue-700 transition">
                        Generar Reporte de Movimientos (PDF)
                    </button>
                </div>
                <div class="flex flex-wrap gap-4 mb-6 items-center"> <!-- Ajustado para alinear verticalmente -->
                    <div>
                        <label for="filtroFechaInicioMov" class="block text-gray-300 text-sm mb-1">Fecha Inicio:</label>
                        <input type="date" id="filtroFechaInicioMov" class="px-3 py-2 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500" />
                    </div>
                    <div>
                        <label for="filtroFechaFinMov" class="block text-gray-300 text-sm mb-1">Fecha Fin:</label>
                        <input type="date" id="filtroFechaFinMov" class="px-3 py-2 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500" />
                    </div>
                    <div>
                        <label for="filtroTipoMov" class="block text-gray-300 text-sm mb-1">Tipo:</label>
                        <select id="filtroTipoMov" class="px-3 py-2 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="">Todos</option>
                            <option value="INCOME">Dep√≥sito</option>
                            <option value="EXPENSE">Retiro/Transferencia</option>
                        </select>
                    </div>
                    <div>
                        <label for="buscadorMovimientos" class="block text-gray-300 text-sm mb-1">Buscar (ID/Descripci√≥n/Cuenta/Usuario):</label>
                        <input
                            type="text"
                            id="buscadorMovimientos"
                            placeholder="Buscar..."
                            class="px-3 py-2 rounded-md bg-gray-700 text-white flex-grow min-w-[200px] focus:outline-none focus:ring-2 focus:ring-emerald-500"
                        />
                    </div>
                    <button
                        id="btnFiltrarMovimientos"
                        class="bg-emerald-600 px-4 py-2 rounded-full hover:bg-emerald-700 transition self-end focus:outline-none focus:ring-2 focus:ring-emerald-400"
                    >
                        Filtrar
                    </button>
                </div>
                <table class="w-full bg-gray-800 rounded-lg overflow-hidden shadow-lg">
                    <thead class="bg-gray-700 text-gray-300">
                        <tr>
                            <th class="py-3 px-4 text-left cursor-pointer" data-orden="date">Fecha ‚Üë‚Üì</th>
                            <th class="py-3 px-4 text-left">Descripci√≥n</th>
                            <th class="py-3 px-4 text-left">Cuenta Origen/Destino</th>
                            <th class="py-3 px-4 text-left">Tipo</th>
                            <th class="py-3 px-4 text-left">Monto</th>
                            <th class="py-3 px-4 text-left">Usuario</th>
                        </tr>
                    </thead>
                    <tbody id="tablaTodosMovimientos" class="text-gray-100">
                        <tr><td colspan="6" class="p-3 text-center text-gray-400">Cargando todos los movimientos...</td></tr>
                    </tbody>
                </table>
            </section>
        `,
        reportes: `
        <section class="max-w-4xl mx-auto min-h-[70vh] p-6 text-white flex flex-col items-center justify-center">
          <h1 class="text-3xl font-bold mb-6 text-emerald-400">Generaci√≥n de Reportes</h1>

          <div class="w-full max-w-md mb-6 space-y-4">
            <button id="btnReporteClientes" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full focus:outline-none focus:shadow-outline transition duration-200 ease-in-out transform hover:scale-105 w-full">
                Generar Reporte de Clientes
            </button>
            <button id="btnReporteMovimientos" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full focus:outline-none focus:shadow-outline transition duration-200 ease-in-out transform hover:scale-105 w-full">
                Generar Reporte de Movimientos
            </button>
            <button id="btnReporteAccesos" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full focus:outline-none focus:shadow-outline transition duration-200 ease-in-out transform hover:scale-105 w-full">
                Generar Reporte de Accesos
            </button>
          </div>
        </section>
        `,
      };

      // Funci√≥n para mostrar SweetAlert2
      function showSweetAlert(icon, title, text, callback = null) {
          Swal.fire({
              icon: icon,
              title: title,
              html: text, // Usar html para permitir saltos de l√≠nea y negritas si es necesario
              background: '#2D3748', // bg-gray-800
              color: '#CBD5E0', // text-gray-300
              confirmButtonColor: '#10B981', // bg-emerald-600
              willClose: callback // Ejecutar callback al cerrar la alerta
          });
      }

      // Elementos del DOM para modales y botones
      const modalEditarCliente = document.getElementById("modalEditarCliente");
      const btnCancelarEditar = document.getElementById("btnCancelarEditar");
      const formEditarCliente = document.getElementById("formEditarCliente");

      const modalRegistrarCliente = document.getElementById("modalRegistrarCliente");
      const btnCancelarRegistro = document.getElementById("btnCancelarRegistro");
      const formRegistrarCliente = document.getElementById("formRegistrarCliente");

      const modalCredenciales = document.getElementById("modalCredenciales");
      const btnCerrarCredenciales = document.getElementById("btnCerrarCredenciales");
      const crearUsuarioEmailSpan = document.getElementById("crearUsuarioEmail");
      const crearUsuarioPasswordSpan = document.getElementById("crearUsuarioPassword");

      const modalConfirmacion = document.getElementById("modalConfirmacion");
      const btnConfirmarCancelar = document.getElementById("btnConfirmarCancelar");
      const btnConfirmarEliminar = document.getElementById("btnConfirmarEliminar");
      let clienteIdAEliminar = null; // Variable para guardar el ID del cliente a eliminar

      // Elementos del formulario de registro de cliente
      const regFirstNameInput = document.getElementById("regFirstName");
      const regLastNameInput = document.getElementById("regLastName");
      const regEmailInput = document.getElementById("regEmail");
      const regDPIInput = document.getElementById("regDPI");
      const regNITInput = document.getElementById("regNIT");
      const regPhoneNumberInput = document.getElementById("regPhoneNumber");
      const regAddressInput = document.getElementById("regAddress");
      const regBirthDateInput = document.getElementById("regBirthDate");

      // Elementos de error de validaci√≥n para registro
      const emailWarning = document.getElementById("emailWarning");
      const dpiWarning = document.getElementById("dpiWarning");
      const nitWarning = document.getElementById("nitWarning");
      const phoneWarning = document.getElementById("phoneWarning");
      const birthDateWarning = document.getElementById("birthDateWarning");

      // Elementos del modal de edici√≥n
      const editarIdCliente = document.getElementById("editarIdCliente");
      const editarNombre = document.getElementById("editarNombre");
      const editarApellido = document.getElementById("editarApellido");
      const editarEmail = document.getElementById("editarEmail");
      const editarDPI = document.getElementById("editarDPI");
      const editarNIT = document.getElementById("editarNIT");
      const editarTelefono = document.getElementById("editarTelefono");
      const editarAddress = document.getElementById("editarAddress");
      const editarBirthDate = document.getElementById("editarBirthDate");
      const editarEstado = document.getElementById("editarEstado"); // Ahora se llama "status" en el backend
      const editarNewPassword = document.getElementById("editarNewPassword");
      const editarConfirmNewPassword = document.getElementById("editarConfirmNewPassword");

      // Elementos de error de validaci√≥n del modal de edici√≥n
      const editarEmailWarning = document.getElementById("editarEmailWarning");
      const editarDpiWarning = document.getElementById("editarDpiWarning");
      const editarNitWarning = document.getElementById("editarNitWarning");
      const editarPhoneWarning = document.getElementById("editarPhoneWarning");
      const editarBirthDateWarning = document.getElementById("editarBirthDateWarning");
      const editMatchWarning = document.getElementById("editMatchWarning");

      // Indicadores de pol√≠tica de contrase√±a para el modal de edici√≥n
      const editPasswordPolicyIndicators = {
          len: document.getElementById('edit-len-indicator'),
          upper: document.getElementById('edit-upper-indicator'),
          lower: document.getElementById('edit-lower-indicator'),
          num: document.getElementById('edit-num-indicator'),
          special: document.getElementById('edit-special-indicator')
      };

      // Elementos para Dep√≥sitos (se obtienen din√°micamente)
      let currentAccountForDeposit = null; // Almacena los datos de la cuenta buscada
      let formDepositoAdmin = null;
      let numeroCuentaBusquedaInput = null;
      let btnBuscarCuenta = null;
      let datosCuentaDiv = null;
      let camposDepositoDiv = null;
      let nombreTitularInput = null;
      let apellidoTitularInput = null;
      let tipoCuentaInput = null;
      let saldoActualInput = null;
      let montoDepositoAdminInput = null;
      let descripcionDepositoAdminInput = null;
      let btnConfirmarDeposito = null;

      // Elementos para Reportes (se obtienen despu√©s de cargar la secci√≥n)
      let btnReporteClientes = null;
      let btnReporteMovimientos = null;
      let btnReporteAccesos = null;


      // --- Funciones de Utilidad para Sidebar ---
      const sidebar = document.getElementById("sidebar");
      const btnToggleSidebar = document.getElementById("btnToggleSidebar");
      const overlay = document.getElementById("overlay");

      let sidebarVisible = false;

      function mostrarSidebar() {
        sidebar.classList.remove("-translate-x-full");
        overlay.classList.remove("opacity-0", "pointer-events-none");
        overlay.classList.add("opacity-100", "pointer-events-auto");
        sidebarVisible = true;
      }

      function ocultarSidebar() {
        sidebar.classList.add("-translate-x-full");
        overlay.classList.add("opacity-0", "pointer-events-none");
        overlay.classList.remove("opacity-100", "pointer-events-auto");
        sidebarVisible = false;
      }

      // --- Validaciones de Campos ---

      // Funci√≥n gen√©rica para actualizar el estado del indicador de contrase√±a
      function updatePasswordIndicator(indicatorElement, isValid) {
          if (isValid) {
              indicatorElement.classList.remove('bg-red-400');
              indicatorElement.classList.add('bg-green-400');
          } else {
              indicatorElement.classList.remove('bg-green-400');
              indicatorElement.classList.add('bg-red-400');
          }
      }

      // Funci√≥n para validar la pol√≠tica de contrase√±a (usada en edici√≥n)
      function validatePasswordPolicy(password, indicators) {
          let isValid = true;

          const isLenValid = password.length >= 8;
          updatePasswordIndicator(indicators.len, isLenValid);
          if (!isLenValid) isValid = false;

          const isUpperValid = /[A-Z]/.test(password);
          updatePasswordIndicator(indicators.upper, isUpperValid);
          if (!isUpperValid) isValid = false;

          const isLowerValid = /[a-z]/.test(password);
          updatePasswordIndicator(indicators.lower, isLowerValid);
          if (!isLowerValid) isValid = false;

          const isNumValid = /\d/.test(password);
          updatePasswordIndicator(indicators.num, isNumValid);
          if (!isNumValid) isValid = false;

          const isSpecialValid = /[!@#$%^&*()\-_=+\\[\]\\{\\}\\|;:'",<.>/?]/.test(password);
          updatePasswordIndicator(indicators.special, isSpecialValid);
          if (!isSpecialValid) isValid = false;

          return isValid;
      }

      // Funci√≥n para validar DPI (13 d√≠gitos num√©ricos)
      function validateDPI(dpi) {
          const regex = /^\d{13}$/;
          return regex.test(dpi);
      }

      // Funci√≥n para validar NIT (formato guatemalteco: 1234567-8 o CF)
      function validateNIT(nit) {
          const regex = /^(CF|[0-9]+-[0-9kK])$/i; // 'i' para ignorar may√∫sculas/min√∫sculas en CF o K
          return regex.test(nit);
      }

      // Funci√≥n para validar Tel√©fono (XXXX-XXXX)
      function validatePhoneNumber(phone) {
          const regex = /^\d{4}-\d{4}$/;
          return regex.test(phone);
      }

      // Funci√≥n para validar Email
      function validateEmail(email) {
          const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return regex.test(email);
      }

      // Funci√≥n para validar fecha de nacimiento (mayor de 18 a√±os)
      function validateBirthDate(birthDateStr) {
          const birthDate = new Date(birthDateStr);
          const today = new Date();
          let age = today.getFullYear() - birthDate.getFullYear();
          const m = today.getMonth() - birthDate.getMonth();
          if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
              age--;
          }
          return age >= 18;
      }

      // --- Event Listeners para validaciones en tiempo real (Formulario de Registro) ---
      // Se adjuntar√°n despu√©s de que la secci√≥n de clientes se cargue din√°micamente

      // --- Event Listeners para validaciones en tiempo real (Modal de Edici√≥n) ---
      // Se adjuntar√°n despu√©s de que el modal de edici√≥n se cargue y se abra

      function setupEditModalListeners() {
          if (editarEmail) {
              editarEmail.addEventListener('input', () => {
                  const isValid = validateEmail(editarEmail.value);
                  editarEmailWarning.classList.toggle("hidden", isValid);
              });
          }
          if (editarDPI) {
              editarDPI.addEventListener('input', () => {
                  const value = editarDPI.value.replace(/\D/g, ''); // Solo n√∫meros
                  editarDPI.value = value; // Actualizar el valor del input
                  const isValid = validateDPI(value);
                  editarDpiWarning.classList.toggle("hidden", isValid);
              });
          }
          if (editarNIT) {
              editarNIT.addEventListener('input', () => {
                  let value = editarNIT.value.replace(/[^0-9kK]/gi, ''); // Solo n√∫meros, k, K (sin guiones), 'i' para case-insensitive
                  let formattedValue = '';

                  if (value.length > 1) { // Si hay al menos 2 caracteres, intentar formatear
                      // Asumimos que el √∫ltimo caracter es el d√≠gito verificador si hay m√°s de 1 digito
                      formattedValue = value.substring(0, value.length - 1) + '-' + value.substring(value.length - 1);
                  } else {
                      formattedValue = value;
                  }

                  // Limitar la longitud total a 10 (8 d√≠gitos + guion + 1 d√≠gito/letra)
                  // Esto es una estimaci√≥n, el NIT real puede variar, pero para el formato GT es com√∫n
                  if (formattedValue.length > 10) {
                      formattedValue = formattedValue.substring(0, 10);
                  }

                  editarNIT.value = formattedValue.toUpperCase(); // Convertir a may√∫sculas para 'K'
                  const isValid = validateNIT(editarNIT.value);
                  editarNitWarning.classList.toggle("hidden", isValid);
              });
          }
          if (editarTelefono) {
              editarTelefono.addEventListener('input', () => {
                  let value = editarTelefono.value.replace(/\D/g, ''); // Eliminar no d√≠gitos
                  if (value.length > 4) {
                      value = value.substring(0, 4) + '-' + value.substring(4, 8);
                  }
                  editarTelefono.value = value;
                  const isValid = validatePhoneNumber(value);
                  editarPhoneWarning.classList.toggle("hidden", isValid);
              });
          }
          if (editarBirthDate) {
              editarBirthDate.addEventListener('change', () => {
                  const isValid = validateBirthDate(editarBirthDate.value);
                  editarBirthDateWarning.classList.toggle("hidden", isValid);
              });
          }

          if (editarNewPassword) {
              editarNewPassword.addEventListener('input', () => {
                  validatePasswordPolicy(editarNewPassword.value, editPasswordPolicyIndicators);
                  if (editarConfirmNewPassword.value !== '') {
                      validateEditPasswordsMatch();
                  }
              });
          }
          if (editarConfirmNewPassword) {
              editarConfirmNewPassword.addEventListener('input', validateEditPasswordsMatch);
          }
      }

      function validateEditPasswordsMatch() {
          const newPass = editarNewPassword.value;
          const confirmPass = editarConfirmNewPassword.value;
          if (newPass === confirmPass && newPass !== '') {
              editMatchWarning.classList.add('hidden');
              return true;
          } else {
              editMatchWarning.classList.remove('hidden');
              return false;
          }
      }

      // --- Fetching Data Functions ---

      async function cargarEstadisticasDashboard() {
          try {
              // CAMBIADO: Ahora se llama al nuevo endpoint espec√≠fico para admin
              const response = await fetch(`${window.location.origin}/api/admin/dashboard-stats`);
              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }
              const data = await response.json();
              dashboardStats.totalUsers = data.totalUsers;
              dashboardStats.activeUsers = data.activeUsers;
              dashboardStats.inactiveUsers = data.inactiveUsers;
              dashboardStats.blockedUsers = data.blockedUsers;

              // Actualizar contenido de la secci√≥n de inicio si ya est√° cargada
              // La secci√≥n de inicio tiene ahora un id="dashboard"
              const dashboardSection = contenido.querySelector('#dashboard');
              if (dashboardSection) {
                  // Re-renderizar el contenido de la secci√≥n de inicio con los datos actualizados
                  dashboardSection.innerHTML = secciones.inicio(dashboardStats);
                  
                  // Re-renderizar gr√°ficos despu√©s de actualizar el HTML
                  const ctxClients = document.getElementById('clientsChart').getContext('2d');
                  clientsChartInstance = new Chart(ctxClients, {
                      type: 'pie',
                      data: {
                          labels: ['Activos', 'Inactivos', 'Bloqueados'],
                          datasets: [{
                              data: [dashboardStats.activeUsers, dashboardStats.inactiveUsers, dashboardStats.blockedUsers],
                              backgroundColor: ['#10B981', '#EF4444', '#F59E0B'], // emerald, red, yellow
                              hoverOffset: 4
                          }]
                      },
                      options: {
                          responsive: true,
                          plugins: {
                              legend: {
                                  labels: {
                                      color: '#CBD5E0' // text-gray-300
                                  }
                              },
                              title: {
                                  display: true,
                                  text: 'Distribuci√≥n de Clientes',
                                  color: '#CBD5E0'
                              }
                          }
                      }
                  });

                  // Gr√°fico de transacciones (datos ficticios por ahora)
                  const ctxTransacciones = document.getElementById("graficoTransacciones");
                  if (ctxTransacciones) {
                      crearGrafico(
                          ctxTransacciones.getContext('2d'),
                          ["Ene", "Feb", "Mar", "Abr", "May", "Jun"],
                          dashboardStats.volumenTransaccionesMes,
                          "Volumen de Transacciones (GTQ)",
                          "rgba(34,197,94,1)"
                      );
                  }

                  // Adjuntar listener al bot√≥n de reporte de accesos
                  const btnReporteAccesosDashboard = document.getElementById("btnReporteAccesos");
                  if (btnReporteAccesosDashboard) {
                      btnReporteAccesosDashboard.addEventListener("click", generarReporteAccesos);
                  }
              }

          } catch (error) {
              console.error('Error al cargar estad√≠sticas del dashboard:', error);
              showSweetAlert("error", "Error", "No se pudieron cargar las estad√≠sticas del dashboard.");
          }
      }


      async function cargarClientes() {
        try {
          const response = await fetch(`${window.location.origin}/api/admin/users`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          serverUsers = await response.json(); // Actualiza la variable global
          renderClientes(); // Vuelve a renderizar la tabla con los datos actualizados

        } catch (error) {
          console.error("Error al cargar clientes:", error);
          showSweetAlert("error", "Error", "No se pudieron cargar los clientes.");
        }
      }

      async function cargarTodosLosMovimientos() {
          const tablaTodosMovimientos = document.getElementById('tablaTodosMovimientos');
          if (!tablaTodosMovimientos) return; // Asegurarse de que el elemento exista

          tablaTodosMovimientos.innerHTML = '<tr><td colspan="6" class="p-3 text-center text-gray-400">Cargando todos los movimientos...</td></tr>';

          try {
              const filtroFechaInicioMov = document.getElementById('filtroFechaInicioMov').value;
              const filtroFechaFinMov = document.getElementById('filtroFechaFinMov').value;
              const filtroTipoMov = document.getElementById('filtroTipoMov').value;
              const buscadorMovimientos = document.getElementById('buscadorMovimientos').value;

              const params = new URLSearchParams();
              if (filtroFechaInicioMov) params.append('startDate', filtroFechaInicioMov);
              if (filtroFechaFinMov) params.append('endDate', filtroFechaFinMov);
              if (filtroTipoMov) params.append('type', filtroTipoMov.toUpperCase());
              if (buscadorMovimientos) params.append('searchTerm', buscadorMovimientos);

              const cacheBuster = new Date().getTime();
              let url = `${window.location.origin}/api/admin/movements/all?_=${cacheBuster}&${params.toString()}`;
              console.log("URL de fetch para todos los movimientos:", url);

              const response = await fetch(url, { cache: 'no-store' });
              if (!response.ok) {
                  console.error(`Error de respuesta para /api/admin/movements/all: Estado ${response.status}, Mensaje: ${response.statusText}`);
                  if (response.status === 401 || response.status === 403) {
                      window.location.href = `${window.location.origin}/login`;
                      throw new Error('No autenticado para ver todos los movimientos.');
                  }
                  throw new Error('Error al obtener todos los movimientos.');
              }
              const movements = await response.json();
              console.log("Todos los movimientos recibidos para admin:", movements);

              // Limpiar la tabla antes de cargar nuevos datos
              tablaTodosMovimientos.innerHTML = '';

              if (movements.length === 0) {
                  const noDataRow = document.createElement('tr');
                  noDataRow.innerHTML = '<td colspan="6" class="p-3 text-center text-gray-400">No hay movimientos registrados que coincidan con los filtros.</td>';
                  tablaTodosMovimientos.appendChild(noDataRow);
                  return;
              }

              // Ordenar los datos por fecha descendente (m√°s reciente primero)
              movements.sort((a, b) => {
                  const dateA = new Date(a.date);
                  const dateB = new Date(b.date);
                  if (dateB.getTime() !== dateA.getTime()) {
                      return dateB.getTime() - dateA.getTime();
                  }
                  return b.id - a.id;
              });

              movements.forEach(mov => {
                  const tipoDisplay = mov.type === 'INCOME' ? 'Dep√≥sito' :
                                      (mov.type === 'EXPENSE' ? 'Retiro/Transferencia' : capitalizeFirstLetter(mov.type));
                  const amountClass = mov.type === 'INCOME' ? 'text-green-400' : 'text-red-400';
                  const amountSign = mov.type === 'INCOME' ? '+' : '-';

                  const row = document.createElement('tr');
                  row.className = 'border-t border-gray-700 hover:bg-gray-700 transition';
                  row.innerHTML = `
                      <td class="py-3 px-4">${mov.date}</td>
                      <td class="py-3 px-4">${mov.description || 'N/A'}</td>
                      <td class="py-3 px-4">${mov.accountNumber || 'N/A'}</td>
                      <td class="py-3 px-4">${tipoDisplay}</td>
                      <td class="py-3 px-4 ${amountClass}">
                          ${amountSign}${formatoMoneda(Math.abs(mov.amount))}
                      </td>
                      <td class="py-3 px-4">${mov.userName || 'Desconocido'}</td>
                  `;
                  tablaTodosMovimientos.appendChild(row);
              });

          } catch (error) {
              console.error('Error al cargar todos los movimientos:', error);
              tablaTodosMovimientos.innerHTML = '<tr><td colspan="6" class="p-3 text-center text-red-400">Error al cargar todos los movimientos.</td></tr>';
              showSweetAlert("error", "Error", `No se pudieron cargar todos los movimientos: ${error.message}`);
          }
      }

      // --- Form Submission Handlers ---

      // Manejar el env√≠o del formulario de registro de cliente
      if (formRegistrarCliente) {
          formRegistrarCliente.addEventListener("submit", async (e) => {
              e.preventDefault();

              // Validaciones de frontend antes de enviar
              let allValid = true;
              if (!validateEmail(regEmailInput.value)) {
                  emailWarning.classList.remove("hidden");
                  allValid = false;
              } else {
                  emailWarning.classList.add("hidden");
              }
              if (!validateDPI(regDPIInput.value)) {
                  dpiWarning.classList.remove("hidden");
                  allValid = false;
              } else {
                  dpiWarning.classList.add("hidden");
              }
              if (!validateNIT(regNITInput.value)) {
                  nitWarning.classList.remove("hidden");
                  allValid = false;
              } else {
                  nitWarning.classList.add("hidden");
              }
              if (!validatePhoneNumber(regPhoneNumberInput.value)) {
                  phoneWarning.classList.remove("hidden");
                  allValid = false;
              } else {
                  phoneWarning.classList.add("hidden");
              }
              if (!validateBirthDate(regBirthDateInput.value)) {
                  birthDateWarning.classList.remove("hidden");
                  allValid = false;
              } else {
                  birthDateWarning.classList.add("hidden");
              }

              if (!allValid) {
                  showSweetAlert("error", "Error de Validaci√≥n", "Por favor, corrija los errores en el formulario.");
                  return;
              }

              const userData = {
                  firstName: regFirstNameInput.value,
                  lastName: regLastNameInput.value,
                  email: regEmailInput.value,
                  dpi: regDPIInput.value.replace(/\D/g, ''), // Enviar solo n√∫meros
                  nit: regNITInput.value.toUpperCase(), // Enviar NIT en may√∫sculas
                  phoneNumber: regPhoneNumberInput.value.replace(/-/g, ''), // Enviar solo n√∫meros
                  birthDate: regBirthDateInput.value, // Formato DD-MM-YYYY
                  address: regAddressInput.value,
                  // enabled: true se establece en el backend ahora
              };

              try {
                  const response = await fetch(`${window.location.origin}/register`, { // Endpoint de registro
                      method: "POST",
                      headers: {
                          "Content-Type": "application/json",
                      },
                      body: JSON.stringify(userData),
                  });

                  if (response.ok) {
                      const newUser = await response.json(); // Espera que el backend devuelva email y password
                      
                      // Mostrar modal de credenciales
                      crearUsuarioEmailSpan.textContent = newUser.email;
                      crearUsuarioPasswordSpan.textContent = newUser.generatedPassword; // Asume que el backend devuelve 'generatedPassword'
                      modalCredenciales.classList.remove("hidden");

                      // Recargar clientes y limpiar formulario
                      cargarClientes();
                      modalRegistrarCliente.classList.add("hidden");
                      formRegistrarCliente.reset();
                      // Ocultar todas las advertencias al limpiar el formulario
                      emailWarning.classList.add("hidden");
                      dpiWarning.classList.add("hidden");
                      nitWarning.classList.add("hidden");
                      phoneWarning.classList.add("hidden");
                      birthDateWarning.classList.add("hidden");

                  } else {
                      const errorData = await response.json(); // Asume que el backend devuelve JSON de error
                      showSweetAlert("error", "Error al Registrar Cliente", errorData.message || `Error al registrar cliente: ${response.statusText}`);
                  }
              } catch (error) {
                  console.error('Error al enviar la solicitud de registro:', error);
                  showSweetAlert("error", "Error de Conexi√≥n", "No se pudo conectar con el servidor para registrar el cliente.");
              }
          });
      }


      // Manejar el env√≠o del formulario de dep√≥sito
      // Se adjuntar√° despu√©s de que la secci√≥n de dep√≥sito se cargue din√°micamente

      // --- Modal de Edici√≥n ---
      function abrirModalEditar(user) {
        editarIdCliente.value = user.id;
        editarNombre.value = user.firstName;
        editarApellido.value = user.lastName;
        editarEmail.value = user.email;
        editarDPI.value = user.dpi || '';
        editarNIT.value = user.nit || '';
        editarTelefono.value = user.phoneNumber || '';
        editarAddress.value = user.address || '';
        // Formatear la fecha de nacimiento a YYYY-MM-DD para el input type="date"
        if (user.birthDate) {
            editarBirthDate.value = user.birthDate;
        } else {
            editarBirthDate.value = '';
        }

        // Seleccionar el estado correcto en el select
        // Ahora se usa user.status directamente
        const estadoOption = Array.from(editarEstado.options).find(option => option.value === user.status);
        if (estadoOption) {
            editarEstado.value = estadoOption.value;
        } else {
            editarEstado.value = 'INACTIVO'; // Fallback si no encuentra
        }

        // Limpiar campos de contrase√±a al abrir el modal
        editarNewPassword.value = '';
        editarConfirmNewPassword.value = '';
        editMatchWarning.classList.add('hidden');
        // Resetear indicadores de pol√≠tica de contrase√±a
        validatePasswordPolicy('', editPasswordPolicyIndicators); // Pasa una cadena vac√≠a para resetear

        // Ocultar todas las advertencias del modal de edici√≥n al abrirlo
        editarEmailWarning.classList.add("hidden");
        editarDpiWarning.classList.add("hidden");
        editarNitWarning.classList.add("hidden");
        editarPhoneWarning.classList.add("hidden");
        editarBirthDateWarning.classList.add("hidden");
        editMatchWarning.classList.add("hidden");


        modalEditarCliente.classList.remove("hidden");
        setupEditModalListeners(); // Adjuntar listeners cada vez que se abre el modal
      }

      // Enviar formulario de edici√≥n al backend
      if (formEditarCliente) {
          formEditarCliente.addEventListener("submit", async function (e) {
              e.preventDefault();

              // Validaciones de frontend antes de enviar
              let allValid = true;
              if (!validateEmail(editarEmail.value)) {
                  editarEmailWarning.classList.remove("hidden");
                  allValid = false;
              } else {
                  editarEmailWarning.classList.add("hidden");
              }
              if (!validateDPI(editarDPI.value)) {
                  editarDpiWarning.classList.remove("hidden");
                  allValid = false;
              } else {
                  editarDpiWarning.classList.add("hidden");
              }
              if (!validateNIT(editarNIT.value)) {
                  editarNitWarning.classList.remove("hidden");
                  allValid = false;
              } else {
                  editarNitWarning.classList.add("hidden");
              }
              if (!validatePhoneNumber(editarTelefono.value)) {
                  editarPhoneWarning.classList.remove("hidden");
                  allValid = false;
              } else {
                  editarPhoneWarning.classList.add("hidden");
              }
              if (!validateBirthDate(editarBirthDate.value)) {
                  editarBirthDateWarning.classList.remove("hidden");
                  allValid = false;
              } else {
                  editarBirthDateWarning.classList.add("hidden");
              }

              // Validar nueva contrase√±a si se ha ingresado
              const newPassword = editarNewPassword.value;
              const confirmNewPassword = editarConfirmNewPassword.value;

              if (newPassword !== '') { // Si se intenta cambiar la contrase√±a
                  if (!validatePasswordPolicy(newPassword, editPasswordPolicyIndicators)) {
                      showSweetAlert('error', 'Error de Contrase√±a', 'La nueva contrase√±a no cumple con la pol√≠tica de seguridad.');
                      return; // Detener el env√≠o si la pol√≠tica no se cumple
                  }
                  if (newPassword !== confirmNewPassword) {
                      showSweetAlert('error', 'Error de Contrase√±a', 'Las nuevas contrase√±as no coinciden.');
                      return; // Detener el env√≠o si no coinciden
                  }
              } else if (confirmNewPassword !== '') { // Si solo se llen√≥ el campo de confirmaci√≥n
                  showSweetAlert('error', 'Error de Contrase√±a', 'Por favor, ingresa la nueva contrase√±a en ambos campos.');
                  return; // Detener el env√≠o
              }

              if (!allValid) {
                  showSweetAlert("error", "Error de Validaci√≥n", "Por favor, corrija los errores en el formulario.");
                  return;
              }

              const datosActualizados = {
                  id: editarIdCliente.value,
                  firstName: editarNombre.value,
                  lastName: editarApellido.value,
                  email: editarEmail.value,
                  dpi: editarDPI.value.replace(/\D/g, ''), // Enviar solo n√∫meros
                  nit: editarNIT.value.toUpperCase(), // Enviar NIT en may√∫sculas
                  phoneNumber: editarTelefono.value.replace(/-/g, ''), // Enviar solo n√∫meros
                  address: editarAddress.value,
                  birthDate: editarBirthDate.value,
                  status: editarEstado.value, // Ahora se env√≠a el campo 'status'
                  newPassword: newPassword // Incluir la nueva contrase√±a si se proporcion√≥
              };

              try {
                  const response = await fetch(`${window.location.origin}/api/users/${datosActualizados.id}`, {
                      method: 'PUT',
                      headers: {
                          'Content-Type': 'application/json'
                      },
                      body: JSON.stringify(datosActualizados)
                  });

                  const data = await response.json();

                  if (response.ok) {
                      showSweetAlert('success', 'Actualizaci√≥n Exitosa', data.message || 'Cliente actualizado correctamente.', () => {
                          modalEditarCliente.classList.add('hidden');
                          cargarClientes(); // Recargar la tabla de clientes
                          cargarEstadisticasDashboard(); // Recargar estad√≠sticas por si el estado cambi√≥
                      });
                  } else {
                      showSweetAlert('error', 'Error al Actualizar', data.message || 'Ocurri√≥ un error al actualizar el cliente.', true);
                  }
              } catch (error) {
                  console.error('Error al actualizar cliente:', error);
                  showSweetAlert('error', 'Error de Conexi√≥n', 'No se pudo conectar con el servidor para actualizar el cliente.', true);
              }
          });
      }

      // Cerrar modal de edici√≥n al hacer clic en cancelar
      if (btnCancelarEditar) {
          btnCancelarEditar.addEventListener("click", () => {
            modalEditarCliente.classList.add("hidden");
          });
      }

      // Cerrar modal de registro al hacer clic en cancelar
      if (btnCancelarRegistro) {
          btnCancelarRegistro.addEventListener("click", () => {
            modalRegistrarCliente.classList.add("hidden");
            formRegistrarCliente.reset(); // Limpiar el formulario al cerrar
            // Ocultar todas las advertencias al cerrar el modal
            emailWarning.classList.add("hidden");
            dpiWarning.classList.add("hidden");
            nitWarning.classList.add("hidden");
            phoneWarning.classList.add("hidden");
            birthDateWarning.classList.add("hidden");
          });
      }

      // Cerrar modal de credenciales
      if (btnCerrarCredenciales) {
          btnCerrarCredenciales.addEventListener("click", () => {
              modalCredenciales.classList.add("hidden");
          });
      }

      // Cerrar modal de confirmaci√≥n al hacer clic en cancelar
      if (btnConfirmarCancelar) {
          btnConfirmarCancelar.addEventListener("click", () => {
              modalConfirmacion.classList.add("hidden");
          });
      }

      // Manejar la eliminaci√≥n del cliente
      if (btnConfirmarEliminar) {
          btnConfirmarEliminar.addEventListener('click', async () => {
              if (clienteIdAEliminar) {
                  try {
                      const response = await fetch(`${window.location.origin}/api/users/${clienteIdAEliminar}`, {
                          method: 'DELETE'
                      });

                      if (response.ok) {
                          showSweetAlert('success', 'Eliminaci√≥n Exitosa', 'Cliente eliminado correctamente.', () => {
                              modalConfirmacion.classList.add('hidden');
                              cargarClientes(); // Recargar la tabla de clientes
                              cargarEstadisticasDashboard(); // Recargar estad√≠sticas
                          });
                      } else {
                          const errorData = await response.json();
                          showSweetAlert('error', 'Error al Eliminar', errorData.message || 'Ocurri√≥ un error al eliminar el cliente.', true);
                      }
                  } catch (error) {
                      console.error('Error al eliminar cliente:', error);
                      showSweetAlert('error', 'Error de Conexi√≥n', 'No se pudo conectar con el servidor para eliminar el cliente.', true);
                  } finally {
                      clienteIdAEliminar = null;
                  }
              }
          });
      }

    // --- L√≥gica de Dep√≥sito para Administradores ---
    async function buscarCuentaPorNumero(accountNumber) {
        try {
            const response = await fetch(`${window.location.origin}/api/accounts/number/${accountNumber}`);
            if (!response.ok) {
                console.error(`Error de respuesta para /api/accounts/number/${accountNumber}: Estado ${response.status}, Mensaje: ${response.statusText}`);
                if (response.status === 404) {
                    showSweetAlert("error", `Cuenta No Encontrada`, `Cuenta con n√∫mero ${accountNumber} no encontrada.`);
                } else if (response.status === 401 || response.status === 403) {
                    window.location.href = `${window.location.origin}/login`;
                    throw new Error('No autenticado');
                } else {
                    throw new Error('Error al buscar la cuenta. Intente de nuevo.');
                }
            }
            const accountData = await response.json();
            return accountData;
        } catch (error) {
            console.error('Error al buscar cuenta:', error);
            showSweetAlert("error", `Error de Conexi√≥n`, `No se pudo buscar la cuenta: ${error.message}`);
            return null;
        }
    }

    function inicializarDepositoAdmin() {
        // Obtener referencias a los elementos del DOM de la secci√≥n de dep√≥sito
        formDepositoAdmin = document.getElementById('formDepositoAdmin');
        numeroCuentaBusquedaInput = document.getElementById('numeroCuentaBusqueda');
        btnBuscarCuenta = document.getElementById('btnBuscarCuenta');
        datosCuentaDiv = document.getElementById('datosCuenta');
        camposDepositoDiv = document.getElementById('camposDeposito');

        nombreTitularInput = document.getElementById('nombreTitular');
        apellidoTitularInput = document.getElementById('apellidoTitular');
        tipoCuentaInput = document.getElementById('tipoCuenta');
        saldoActualInput = document.getElementById('saldoActual');
        montoDepositoAdminInput = document.getElementById('montoDepositoAdmin');
        descripcionDepositoAdminInput = document.getElementById('descripcionDepositoAdmin');
        btnConfirmarDeposito = document.getElementById('btnConfirmarDeposito');

        // Resetear el estado inicial de la secci√≥n
        if (datosCuentaDiv) datosCuentaDiv.classList.add('hidden');
        if (camposDepositoDiv) camposDepositoDiv.classList.add('hidden');
        currentAccountForDeposit = null;

        if (btnBuscarCuenta) {
            btnBuscarCuenta.onclick = async () => {
                const accountNumber = numeroCuentaBusquedaInput.value.trim();
                if (!accountNumber) {
                    showSweetAlert("warning", 'Advertencia', 'Por favor, ingrese un n√∫mero de cuenta.');
                    return;
                }

                // Limpiar campos y ocultar secciones al buscar una nueva cuenta
                if (nombreTitularInput) nombreTitularInput.value = '';
                if (apellidoTitularInput) apellidoTitularInput.value = '';
                if (tipoCuentaInput) tipoCuentaInput.value = '';
                if (saldoActualInput) saldoActualInput.value = '';
                if (datosCuentaDiv) datosCuentaDiv.classList.add('hidden');
                if (camposDepositoDiv) camposDepositoDiv.classList.add('hidden');
                currentAccountForDeposit = null;

                const account = await buscarCuentaPorNumero(accountNumber);

                if (account) {
                    currentAccountForDeposit = account;
                    if (nombreTitularInput) nombreTitularInput.value = account.userName || 'N/A';
                    if (apellidoTitularInput) apellidoTitularInput.value = account.userLastName || 'N/A';
                    if (tipoCuentaInput) tipoCuentaInput.value = account.accountType || 'N/A';
                    if (saldoActualInput) saldoActualInput.value = formatoMoneda(account.balance);

                    if (datosCuentaDiv) datosCuentaDiv.classList.remove('hidden');
                    if (camposDepositoDiv) camposDepositoDiv.classList.remove('hidden');
                    if (montoDepositoAdminInput) montoDepositoAdminInput.focus();
                } else {
                    if (datosCuentaDiv) datosCuentaDiv.classList.add('hidden');
                    if (camposDepositoDiv) camposDepositoDiv.classList.add('hidden');
                }
            };
        }

        if (formDepositoAdmin) {
            formDepositoAdmin.onsubmit = async e => {
                e.preventDefault();

                if (!currentAccountForDeposit) {
                    showSweetAlert("error", 'Error', 'Por favor, busque y seleccione una cuenta primero.');
                    return;
                }

                const accountNumber = currentAccountForDeposit.accountNumber;
                const amount = parseFloat(montoDepositoAdminInput.value);
                const description = descripcionDepositoAdminInput.value.trim();

                if (isNaN(amount) || amount <= 0) {
                    showSweetAlert("error", 'Error de Monto', 'Por favor, ingrese un monto v√°lido mayor a cero.');
                    return;
                }

                try {
                    const response = await fetch(`${window.location.origin}/api/transactions/deposit`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            accountNumber: accountNumber,
                            amount: amount,
                            description: description,
                            type: 'INCOME'
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        console.error(`Error de respuesta para /api/transactions/deposit: Estado ${response.status}, Mensaje: ${response.statusText}`);
                        showSweetAlert("error", 'Error en Dep√≥sito', data.message || 'Error al realizar el dep√≥sito. Verifique los datos e intente de nuevo.');
                        return;
                    }

                    showSweetAlert("success", 'Dep√≥sito Exitoso', `Dep√≥sito de ${formatoMoneda(amount)} en la cuenta ${accountNumber} realizado con √©xito. Nuevo saldo: ${formatoMoneda(data.newOriginAccountBalance)}`, () => {
                        formDepositoAdmin.reset();
                        if (numeroCuentaBusquedaInput) numeroCuentaBusquedaInput.value = '';
                        if (datosCuentaDiv) datosCuentaDiv.classList.add('hidden');
                        if (camposDepositoDiv) camposDepositoDiv.classList.add('hidden');
                        currentAccountForDeposit = null;
                        // Opcional: Recargar la tabla de movimientos si est√° visible
                        if (contenido.querySelector('#tablaTodosMovimientos')) {
                            cargarTodosMovimientos();
                        }
                    });

                } catch (error) {
                    console.error('Error al realizar el dep√≥sito:', error);
                    showSweetAlert("error", 'Error de Conexi√≥n', `No se pudo conectar con el servidor para realizar el dep√≥sito: ${error.message}`);
                }
            };
        }
    }

    // Function to initialize the "Todos los Movimientos" section
    function inicializarTodosMovimientos() {
        console.log("Inicializando Todos los Movimientos...");
        cargarTodosLosMovimientos(); // Call the function to fetch and display movements
    }


    /**
     * Inicializa la secci√≥n del Dashboard de Administrador.
     */
    async function inicializarDashboardAdmin() {
        console.log("Inicializando Dashboard de Administrador...");
        await cargarEstadisticasDashboard(); // Carga las estad√≠sticas y actualiza el HTML de la secci√≥n 'inicio'
    }

    /**
     * Funci√≥n para generar reportes PDF (JasperReports).
     * Estas funciones se conectan a tus endpoints de Spring Boot.
     */
    async function generarReporteClientes() {
        try {
            window.open(`${window.location.origin}/api/reports/clients/pdf`, '_blank');
        } catch (error) {
            console.error('Error al generar reporte de clientes:', error);
            showSweetAlert("error", "Error", "No se pudo generar el reporte de clientes.");
        }
    }

    async function generarReporteMovimientos() {
        try {
            // Obtener los valores de los filtros para pasarlos al backend
            const filtroFechaInicioMov = document.getElementById('filtroFechaInicioMov');
            const filtroFechaFinMov = document.getElementById('filtroFechaFinMov');
            const filtroTipoMov = document.getElementById('filtroTipoMov');
            const buscadorMovimientos = document.getElementById('buscadorMovimientos');

            const params = new URLSearchParams();
            if (filtroFechaInicioMov && filtroFechaInicioMov.value) params.append('startDate', filtroFechaInicioMov.value);
            if (filtroFechaFinMov && filtroFechaFinMov.value) params.append('endDate', filtroFechaFinMov.value);
            if (filtroTipoMov && filtroTipoMov.value) params.append('type', filtroTipoMov.value.toUpperCase());
            if (buscadorMovimientos && buscadorMovimientos.value) params.append('searchTerm', buscadorMovimientos.value); // Pasar el t√©rmino de b√∫squeda

            window.open(`${window.location.origin}/api/reports/movements/pdf?${params.toString()}`, '_blank');
        } catch (error) {
            console.error('Error al generar reporte de movimientos:', error);
            showSweetAlert("error", "Error", "No se pudo generar el reporte de movimientos.");
        }
    }

    async function generarReporteAccesos() {
        try {
            window.open(`${window.location.origin}/api/reports/user-access/pdf`, '_blank');
        } catch (error) {
            console.error('Error al generar reporte de accesos:', error);
            showSweetAlert("error", "Error", "No se pudo generar el reporte de accesos.");
        }
    }


    // Renderiza la lista de clientes con filtro y acciones
    function renderClientes() {
        const tbody = document.getElementById("tablaClientes");
        const buscadorClientes = document.getElementById("buscadorClientes");
        const filtro = buscadorClientes ? buscadorClientes.value.toLowerCase() : "";
        let html = "";

        const filtrados = serverUsers.filter(
            (c) =>
                c.id.toString().includes(filtro) ||
                c.firstName.toLowerCase().includes(filtro) ||
                c.lastName.toLowerCase().includes(filtro) ||
                c.email.toLowerCase().includes(filtro) ||
                (c.dpi && c.dpi.toLowerCase().includes(filtro)) ||
                (c.nit && c.nit.toLowerCase().includes(filtro)) ||
                (c.phoneNumber && c.phoneNumber.toLowerCase().includes(filtro))
        );

        if (tbody) { // Asegurarse de que el tbody exista antes de manipularlo
            if (filtrados.length === 0) {
                html = `<tr><td colspan="9" class="text-center py-6 text-gray-500">No se encontraron clientes.</td></tr>`;
            } else {
                filtrados.forEach((c) => {
                    html += `
                        <tr class="border-b border-gray-700 last:border-b-0">
                            <td class="py-3 px-4">${c.id}</td>
                            <td class="py-3 px-4">${c.firstName}</td>
                            <td class="py-3 px-4">${c.lastName}</td>
                            <td class="py-3 px-4">${c.email}</td>
                            <td class="py-3 px-4">${c.dpi || 'N/A'}</td>
                            <td class="py-3 px-4">${c.nit || 'N/A'}</td>
                            <td class="py-3 px-4">${c.phoneNumber || 'N/A'}</td>
                            <td class="py-3 px-4">${c.status || 'N/A'}</td> <!-- Usar c.status -->
                            <td class="py-3 px-4 space-x-2">
                                <button class="text-yellow-400 hover:underline btnEditarCliente" data-id="${c.id}">Editar</button>
                                <button class="text-red-500 hover:underline btnEliminarCliente" data-id="${c.id}">Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
            }
            tbody.innerHTML = html;

            // Re-adjuntar event listeners a los botones de editar/eliminar despu√©s de recargar la tabla
            document.querySelectorAll(".btnEditarCliente").forEach(button => {
                button.addEventListener("click", (e) => {
                    const clienteId = e.target.dataset.id;
                    const clienteAEditar = serverUsers.find(user => user.id.toString() === clienteId);
                    if (clienteAEditar) {
                        abrirModalEditar(clienteAEditar);
                    }
                });
            });

            document.querySelectorAll(".btnEliminarCliente").forEach(button => {
                button.addEventListener("click", (e) => {
                    clienteIdAEliminar = e.target.dataset.id;
                    modalConfirmacion.classList.remove('hidden');
                });
            });
        }
    }


    // Funci√≥n para cargar secci√≥n y activar enlaces
    function cambiarPestania(id) {
        // Quitar clase active de todos
        sidebarLinks.forEach((link) => {
            link.classList.remove("bg-emerald-600", "text-white");
            link.classList.add("hover:bg-emerald-700");
        });
        // Agregar active al clickeado
        const linkActivo = Array.from(sidebarLinks).find(
            (link) => link.dataset.id === id
        );
        if (linkActivo) {
            linkActivo.classList.add("bg-emerald-600", "text-white");
            linkActivo.classList.remove("hover:bg-emerald-700");
        }
        
        // Cambiar contenido
        contenido.innerHTML = secciones[id](dashboardStats) || '<p class="text-center mt-20 text-gray-400">Secci√≥n no disponible.</p>';

        // Cerrar sidebar en m√≥vil despu√©s de seleccionar una opci√≥n
        if (window.innerWidth < 1024) {
          ocultarSidebar();
        }

        // Al cargar cada secci√≥n, ejecutar funciones espec√≠ficas
        if (id === "inicio") {
          inicializarDashboardAdmin();
        } else if (id === "clientes") {
            cargarClientes();
            // Adjuntar listeners para el formulario de registro y buscador despu√©s de cargar la secci√≥n
            const btnAbrirModalRegistro = document.getElementById("btnAbrirModalRegistro");
            if (btnAbrirModalRegistro) {
                btnAbrirModalRegistro.addEventListener("click", () => {
                    modalRegistrarCliente.classList.remove("hidden");
                    // Limpiar y resetear advertencias al abrir el modal de registro
                    formRegistrarCliente.reset();
                    emailWarning.classList.add("hidden");
                    dpiWarning.classList.add("hidden");
                    nitWarning.classList.add("hidden");
                    phoneWarning.classList.add("hidden");
                    birthDateWarning.classList.add("hidden");
                });
            }
            const buscadorClientesElem = document.getElementById("buscadorClientes");
            if (buscadorClientesElem) {
                buscadorClientesElem.addEventListener("input", renderClientes);
            }
            const btnReporteClientesSection = document.getElementById("btnReporteClientes");
            if (btnReporteClientesSection) {
                btnReporteClientesSection.addEventListener("click", generarReporteClientes);
            }

            // Adjuntar listeners de validaci√≥n para el formulario de registro
            if (regEmailInput) regEmailInput.addEventListener('input', () => {
                const isValid = validateEmail(regEmailInput.value);
                emailWarning.classList.toggle("hidden", isValid);
            });
            if (regDPIInput) regDPIInput.addEventListener('input', () => {
                const value = regDPIInput.value.replace(/\D/g, ''); // Solo n√∫meros
                regDPIInput.value = value; // Actualizar el valor del input
                const isValid = validateDPI(value);
                dpiWarning.classList.toggle("hidden", isValid);
            });
            if (regNITInput) regNITInput.addEventListener('input', () => {
                let value = regNITInput.value.replace(/[^0-9kK]/gi, ''); // Solo n√∫meros, k, K (sin guiones), 'i' para case-insensitive
                let formattedValue = '';

                if (value.length > 1) { // Si hay al menos 2 caracteres, intentar formatear
                    formattedValue = value.substring(0, value.length - 1) + '-' + value.substring(value.length - 1);
                } else {
                    formattedValue = value;
                }

                if (formattedValue.length > 10) {
                    formattedValue = formattedValue.substring(0, 10);
                }

                regNITInput.value = formattedValue.toUpperCase(); // Convertir a may√∫sculas para 'K'
                const isValid = validateNIT(regNITInput.value);
                nitWarning.classList.toggle("hidden", isValid);
            });
            if (regPhoneNumberInput) regPhoneNumberInput.addEventListener('input', () => {
                let value = regPhoneNumberInput.value.replace(/\D/g, ''); // Eliminar no d√≠gitos
                if (value.length > 4) {
                    value = value.substring(0, 4) + '-' + value.substring(4, 8);
                }
                regPhoneNumberInput.value = value;
                const isValid = validatePhoneNumber(value);
                phoneWarning.classList.toggle("hidden", isValid);
            });
            if (regBirthDateInput) regBirthDateInput.addEventListener('change', () => {
                const isValid = validateBirthDate(regBirthDateInput.value);
                birthDateWarning.classList.toggle("hidden", isValid);
            });


        } else if (id === "deposito") {
            inicializarDepositoAdmin();
        } else if (id === "todosMovimientos") {
            inicializarTodosMovimientos();
            // Adjuntar listener para el bot√≥n de reporte de movimientos
            const btnReporteMovimientosSection = document.getElementById("btnReporteMovimientos");
            if (btnReporteMovimientosSection) {
                btnReporteMovimientosSection.addEventListener("click", generarReporteMovimientos);
            }
            const filtroFechaInicioMov = document.getElementById('filtroFechaInicioMov');
            const filtroFechaFinMov = document.getElementById('filtroFechaFinMov');
            const filtroTipoMov = document.getElementById('filtroTipoMov');
            const buscadorMovimientos = document.getElementById('buscadorMovimientos');
            const btnFiltrarMovimientos = document.getElementById('btnFiltrarMovimientos');

            if (btnFiltrarMovimientos) {
                btnFiltrarMovimientos.onclick = cargarTodosMovimientos;
            }
            if (filtroFechaInicioMov) filtroFechaInicioMov.addEventListener("change", cargarTodosMovimientos);
            if (filtroFechaFinMov) filtroFechaFinMov.addEventListener("change", cargarTodosMovimientos);
            if (filtroTipoMov) filtroTipoMov.addEventListener("change", cargarTodosMovimientos);
            if (buscadorMovimientos) buscadorMovimientos.addEventListener("input", cargarTodosMovimientos);

        } else if (id === "reportes") {
            // Adjuntar listeners a los botones de reporte
            const btnReporteClientesSection = document.getElementById("btnReporteClientes");
            const btnReporteMovimientosSection = document.getElementById("btnReporteMovimientos");
            const btnReporteAccesosSection = document.getElementById("btnReporteAccesos");

            if (btnReporteClientesSection) {
                btnReporteClientesSection.addEventListener("click", generarReporteClientes);
            }
            if (btnReporteMovimientosSection) {
                btnReporteMovimientosSection.addEventListener("click", generarReporteMovimientos);
            }
            if (btnReporteAccesosSection) {
                btnReporteAccesosSection.addEventListener("click", generarReporteAccesos);
            }
        }
    }

    // --- Event Listeners Globales ---
    btnToggleSidebar.addEventListener("click", mostrarSidebar); // Cambiado a mostrarSidebar
    overlay.addEventListener("click", ocultarSidebar); // Cambiado a ocultarSidebar

    sidebarLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
            e.preventDefault();
            const id = link.dataset.id;
            cambiarPestania(id);
        });
    });

    // Manejar el cierre de sesi√≥n
    document.querySelector('a[data-id="cerrarSesion"]').addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = `${window.location.origin}/logout`;
    });


    // Mostrar inicio por defecto al cargar el DOM
    document.addEventListener('DOMContentLoaded', () => {
        cambiarPestania("inicio");
    });
    </script>
  </body>
</html>
